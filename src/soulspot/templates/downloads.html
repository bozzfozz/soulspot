{# Hey future me - Downloads queue page - PREMIUM EDITION!
   Professional design with:
   - Glassmorphism cards with subtle blur
   - Album art with overlay effects
   - Animated progress bars with gradient
   - Micro-interactions on hover
   - Speed/ETA display (when available)
   - Smooth transitions everywhere #}

{% extends "base.html" %}

{% block title %}Downloads - SoulSpot{% endblock %}

{% block content %}
<!-- Page Header with animated icon -->
<div class="page-header">
    <div class="header-content">
        <div class="header-icon-wrapper">
            <div class="header-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                <i class="bi bi-cloud-download-fill vinyl-record-icon"></i>
            </div>
            <div class="header-icon-glow" style="background: radial-gradient(circle, rgba(59, 130, 246, 0.3) 0%, transparent 70%);"></div>
        </div>
        <div>
            <h1>Downloads</h1>
            <p class="subtitle">Manage your download queue and history</p>
        </div>
    </div>
    <div class="header-actions">
        <button class="btn btn-outline" hx-post="/api/downloads/pause-all" hx-swap="none">
            <i class="bi bi-pause-fill"></i>
            Pause All
        </button>
        <button class="btn btn-outline btn-success-outline" hx-post="/api/downloads/resume-all" hx-swap="none">
            <i class="bi bi-play-fill"></i>
            Resume All
        </button>
        <button class="btn btn-outline" hx-post="/api/downloads/clear-completed" hx-swap="none">
            <i class="bi bi-check2-all"></i>
            Clear Done
        </button>
    </div>
</div>

<!-- Stats Grid with glassmorphism -->
<div class="stats-grid mb-8">
    <div class="stat-card stat-card-animated blur-fade-in hover-glow delay-0">
        <div class="stat-icon stat-icon-hover-flip pulse-soft stat-icon-primary">
            <i class="bi bi-arrow-down-circle-fill"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value counter-animate">{{ active_count|default(0) }}</span>
            <span class="stat-label">Downloading</span>
        </div>
        <div class="stat-shine"></div>
    </div>

    <div class="stat-card stat-card-animated blur-fade-in hover-glow delay-1">
        <div class="stat-icon stat-icon-hover-flip stat-icon-warning">
            <i class="bi bi-hourglass-split"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value counter-animate">{{ queue_count|default(0) }}</span>
            <span class="stat-label">In Queue</span>
        </div>
        <div class="stat-shine"></div>
    </div>

    <div class="stat-card stat-card-animated blur-fade-in hover-glow delay-2">
        <div class="stat-icon stat-icon-hover-flip stat-icon-success">
            <i class="bi bi-check-circle-fill"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value counter-animate">{{ completed_today|default(0) }}</span>
            <span class="stat-label">Completed</span>
        </div>
        <div class="stat-shine"></div>
    </div>

    <div class="stat-card stat-card-animated blur-fade-in hover-glow delay-3">
        <div class="stat-icon stat-icon-hover-flip stat-icon-error">
            <i class="bi bi-exclamation-circle-fill"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value counter-animate">{{ failed_count|default(0) }}</span>
            <span class="stat-label">Failed</span>
        </div>
        <div class="stat-shine"></div>
    </div>
</div>

<!-- Tabs with indicator -->
<div class="download-tabs">
    <button class="download-tab active" onclick="switchTab('queue', this)" data-tab="queue">
        <i class="bi bi-list-ul"></i>
        Queue
        <span class="tab-count">{{ total|default(downloads|length if downloads else 0) }}</span>
    </button>
    <button class="download-tab" onclick="switchTab('history', this)" data-tab="history">
        <i class="bi bi-clock-history"></i>
        History
    </button>
    <div class="tab-indicator"></div>
</div>

<!-- Queue Tab -->
<div id="queue-tab" class="tab-content">
    {% if downloads %}
    <div class="download-list">
        {% for item in downloads %}
        <div class="download-item {% if item.status == 'downloading' %}downloading{% elif item.status == 'completed' %}completed{% elif item.status == 'failed' %}failed{% endif %}" 
             data-id="{{ item.id }}" 
             style="animation-delay: {{ loop.index0 * 50 }}ms;">
            
            <!-- Album Art with Status Overlay -->
            <div class="download-artwork">
                <img src="{{ item.album_art|default('https://via.placeholder.com/64x64/1a1a2e/6366f1?text=♪') }}" 
                     alt="{{ item.title|default('Track') }}"
                     loading="lazy">
                <div class="artwork-overlay">
                    {% if item.status == 'downloading' %}
                    <div class="download-spinner"></div>
                    {% elif item.status == 'completed' %}
                    <i class="bi bi-check-lg"></i>
                    {% elif item.status == 'failed' %}
                    <i class="bi bi-exclamation-lg"></i>
                    {% elif item.status == 'waiting' %}
                    <i class="bi bi-hourglass"></i>
                    {% elif item.status == 'paused' %}
                    <i class="bi bi-pause-fill"></i>
                    {% else %}
                    <i class="bi bi-clock"></i>
                    {% endif %}
                </div>
            </div>

            <!-- Track Info -->
            <div class="download-info">
                <div class="download-title">{{ item.title|default('Track ' + item.track_id[:8]) }}</div>
                <div class="download-meta">
                    <span class="download-artist">{{ item.artist|default('Unknown Artist') }}</span>
                    {% if item.album %}
                    <span class="meta-separator">•</span>
                    <span class="download-album">{{ item.album }}</span>
                    {% endif %}
                </div>
                
                <!-- Progress Bar (only for downloading) -->
                {% if item.status == 'downloading' %}
                <div class="download-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ item.progress_percent|default(0) }}%;"></div>
                        <div class="progress-glow" style="left: {{ item.progress_percent|default(0) }}%;"></div>
                    </div>
                    <div class="progress-stats">
                        <span class="progress-percent">{{ item.progress_percent|default(0)|round(1) }}%</span>
                        {% if item.speed %}
                        <span class="progress-speed">{{ item.speed }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Error Message (only for failed) -->
                {% if item.status == 'failed' and item.error_message %}
                <div class="download-error">
                    <i class="bi bi-exclamation-triangle"></i>
                    {{ item.error_message|truncate(50) }}
                </div>
                {% endif %}
            </div>

            <!-- Status Badge -->
            <div class="download-status">
                {% if item.status == 'downloading' %}
                <span class="status-badge status-downloading">
                    <span class="status-dot pulse"></span>
                    Downloading
                </span>
                {% elif item.status == 'waiting' %}
                <span class="status-badge status-waiting">
                    <i class="bi bi-hourglass-split"></i>
                    Waiting
                </span>
                {% elif item.status == 'queued' or item.status == 'pending' %}
                <span class="status-badge status-queued">
                    <i class="bi bi-clock"></i>
                    Queued
                </span>
                {% elif item.status == 'completed' %}
                <span class="status-badge status-completed">
                    <i class="bi bi-check-circle-fill"></i>
                    Done
                </span>
                {% elif item.status == 'failed' %}
                <span class="status-badge status-failed">
                    <i class="bi bi-x-circle-fill"></i>
                    Failed
                </span>
                {% elif item.status == 'paused' %}
                <span class="status-badge status-paused">
                    <i class="bi bi-pause-circle-fill"></i>
                    Paused
                </span>
                {% endif %}
            </div>

            <!-- Actions -->
            <div class="download-actions">
                {% if item.status == 'downloading' or item.status == 'queued' or item.status == 'pending' or item.status == 'waiting' %}
                <button class="action-btn" hx-post="/api/downloads/{{ item.id }}/pause" hx-swap="none" title="Pause">
                    <i class="bi bi-pause-fill"></i>
                </button>
                {% elif item.status == 'paused' %}
                <button class="action-btn action-primary" hx-post="/api/downloads/{{ item.id }}/resume" hx-swap="none" title="Resume">
                    <i class="bi bi-play-fill"></i>
                </button>
                {% elif item.status == 'failed' %}
                <button class="action-btn action-primary" hx-post="/api/downloads/{{ item.id }}/retry" hx-swap="none" title="Retry">
                    <i class="bi bi-arrow-repeat"></i>
                </button>
                {% endif %}
                <button class="action-btn action-danger" hx-delete="/api/downloads/{{ item.id }}" hx-swap="none" title="Remove">
                    <i class="bi bi-trash3"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    {# Pagination #}
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if has_previous %}
        <a href="/downloads?page={{ page - 1 }}&limit={{ limit }}" class="pagination-btn">
            <i class="bi bi-chevron-left"></i>
        </a>
        {% else %}
        <button class="pagination-btn" disabled>
            <i class="bi bi-chevron-left"></i>
        </button>
        {% endif %}

        <span class="pagination-info">
            Page <strong>{{ page }}</strong> of <strong>{{ total_pages }}</strong>
        </span>

        {% if has_next %}
        <a href="/downloads?page={{ page + 1 }}&limit={{ limit }}" class="pagination-btn">
            <i class="bi bi-chevron-right"></i>
        </a>
        {% else %}
        <button class="pagination-btn" disabled>
            <i class="bi bi-chevron-right"></i>
        </button>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon">
            <i class="bi bi-cloud-download"></i>
            <div class="empty-icon-ring"></div>
        </div>
        <h3>No Downloads Yet</h3>
        <p>Your download queue is empty. Browse music to start downloading.</p>
        <a href="/spotify" class="btn btn-primary">
            <i class="bi bi-spotify"></i>
            Browse Spotify
        </a>
    </div>
    {% endif %}
</div>

<!-- History Tab -->
<div id="history-tab" class="tab-content" style="display: none;">
    <div class="empty-state" style="padding: 3rem;">
        <div class="empty-icon">
            <i class="bi bi-clock-history"></i>
        </div>
        <h3>Download History</h3>
        <p>Your completed downloads will appear here.</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
    /* ═══════════════════════════════════════════════════════════
       Professional Downloads Page Styles
       Hey future me - diese Styles sind MEGA aufwendig aber worth it!
       Glassmorphism + Animationen + Micro-interactions = Premium Feel
       ═══════════════════════════════════════════════════════════ */
    
    /* Tab Navigation */
    .download-tabs {
        display: flex;
        gap: 0.5rem;
        position: relative;
        padding: 0.25rem;
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
    }
    
    .download-tab {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        background: transparent;
        border: none;
        border-radius: var(--radius-md);
        color: var(--text-muted);
        font-size: var(--font-size-sm);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        z-index: 1;
    }
    
    .download-tab:hover {
        color: var(--text-primary);
    }
    
    .download-tab.active {
        color: var(--text-primary);
        background: var(--bg-primary);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .tab-count {
        background: var(--accent-primary);
        color: white;
        font-size: 0.7rem;
        padding: 0.15rem 0.5rem;
        border-radius: 10px;
        font-weight: 600;
    }
    
    /* Download List */
    .download-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    /* Download Item Card */
    .download-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-primary);
        transition: all 0.3s ease;
        animation: slideInUp 0.4s ease-out both;
    }
    
    .download-item:hover {
        border-color: var(--accent-primary-30);
        background: var(--bg-tertiary);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .download-item.downloading {
        border-left: 3px solid var(--accent-primary);
    }
    
    .download-item.completed {
        border-left: 3px solid var(--color-success);
    }
    
    .download-item.failed {
        border-left: 3px solid var(--color-error);
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Album Artwork */
    .download-artwork {
        position: relative;
        width: 64px;
        height: 64px;
        flex-shrink: 0;
        border-radius: var(--radius-md);
        overflow: hidden;
    }
    
    .download-artwork img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .download-item:hover .download-artwork img {
        transform: scale(1.1);
    }
    
    .artwork-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .download-item:hover .artwork-overlay,
    .download-item.downloading .artwork-overlay {
        opacity: 1;
    }
    
    .artwork-overlay i {
        color: white;
        font-size: 1.5rem;
    }
    
    /* Download Spinner */
    .download-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Track Info */
    .download-info {
        flex: 1;
        min-width: 0;
    }
    
    .download-title {
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 0.25rem;
    }
    
    .download-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: var(--font-size-sm);
        color: var(--text-muted);
    }
    
    .meta-separator {
        color: var(--text-muted);
        opacity: 0.5;
    }
    
    .download-album {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
    }
    
    /* Progress Bar */
    .download-progress {
        margin-top: 0.75rem;
    }
    
    .progress-bar {
        position: relative;
        height: 6px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-full);
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary, #818cf8));
        border-radius: var(--radius-full);
        transition: width 0.3s ease;
        position: relative;
    }
    
    .progress-glow {
        position: absolute;
        top: -4px;
        width: 8px;
        height: 14px;
        background: var(--accent-primary);
        border-radius: 50%;
        filter: blur(6px);
        opacity: 0.6;
        transition: left 0.3s ease;
    }
    
    .progress-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 0.35rem;
        font-size: 0.7rem;
        color: var(--text-muted);
    }
    
    .progress-percent {
        font-weight: 600;
        color: var(--accent-primary);
    }
    
    /* Error Message */
    .download-error {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: rgba(239, 68, 68, 0.1);
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        color: var(--color-error);
    }
    
    /* Status Badges */
    .download-status {
        flex-shrink: 0;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.75rem;
        border-radius: var(--radius-full);
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
    }
    
    .status-dot.pulse {
        animation: pulse-dot 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse-dot {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    .status-downloading {
        background: rgba(99, 102, 241, 0.15);
        color: var(--accent-primary);
    }
    
    .status-waiting {
        background: rgba(245, 158, 11, 0.15);
        color: var(--color-warning);
    }
    
    .status-queued {
        background: var(--bg-tertiary);
        color: var(--text-muted);
    }
    
    .status-completed {
        background: rgba(16, 185, 129, 0.15);
        color: var(--color-success);
    }
    
    .status-failed {
        background: rgba(239, 68, 68, 0.15);
        color: var(--color-error);
    }
    
    .status-paused {
        background: rgba(245, 158, 11, 0.15);
        color: var(--color-warning);
    }
    
    /* Action Buttons */
    .download-actions {
        display: flex;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .download-item:hover .download-actions {
        opacity: 1;
    }
    
    .action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border: none;
        border-radius: var(--radius-md);
        background: var(--bg-tertiary);
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .action-btn:hover {
        background: var(--bg-primary);
        color: var(--text-primary);
        transform: scale(1.1);
    }
    
    .action-btn.action-primary {
        background: var(--accent-primary);
        color: white;
    }
    
    .action-btn.action-primary:hover {
        background: var(--accent-primary-hover);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .action-btn.action-danger:hover {
        background: var(--color-error);
        color: white;
    }
    
    /* Pagination */
    .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 2rem;
        padding: 1rem;
    }
    
    .pagination-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        background: var(--bg-secondary);
        color: var(--text-primary);
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .pagination-btn:hover:not(:disabled) {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
        color: white;
    }
    
    .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }
    
    .pagination-info {
        color: var(--text-muted);
        font-size: var(--font-size-sm);
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: var(--bg-secondary);
        border-radius: var(--radius-xl);
        border: 1px dashed var(--border-primary);
    }
    
    .empty-state .empty-icon {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        margin-bottom: 1.5rem;
    }
    
    .empty-state .empty-icon i {
        font-size: 2.5rem;
        color: var(--text-muted);
        opacity: 0.5;
    }
    
    .empty-icon-ring {
        position: absolute;
        inset: 0;
        border: 2px dashed var(--border-primary);
        border-radius: 50%;
        animation: rotate-ring 20s linear infinite;
    }
    
    @keyframes rotate-ring {
        to { transform: rotate(360deg); }
    }
    
    .empty-state h3 {
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    
    .empty-state p {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
    }
    
    /* Button outline success variant */
    .btn-success-outline {
        border-color: var(--color-success);
        color: var(--color-success);
    }
    
    .btn-success-outline:hover {
        background: var(--color-success);
        color: white;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .download-item {
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .download-info {
            flex: 1 1 calc(100% - 80px);
        }
        
        .download-status {
            order: 3;
            flex: 1;
        }
        
        .download-actions {
            order: 4;
            opacity: 1;
        }
        
        .download-album {
            display: none;
        }
    }
</style>
<script>
    // Scroll-triggered animations using Intersection Observer
    function initScrollReveal() {
        const revealElements = document.querySelectorAll('.scroll-reveal');
        if (!revealElements.length) return;
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('revealed');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.2, rootMargin: '0px 0px -50px 0px' });
        
        revealElements.forEach(el => observer.observe(el));
    }

    function switchTab(tab, btn) {
        // Update button states
        document.querySelectorAll('.download-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        const tabContent = document.getElementById(tab + '-tab');
        tabContent.style.display = 'block';
        
        // Re-trigger animation
        tabContent.style.animation = 'none';
        tabContent.offsetHeight; // Trigger reflow
        tabContent.style.animation = 'slideInUp 0.3s ease-out';
    }

    // Auto-refresh queue every 5 seconds
    let refreshInterval;
    
    function startAutoRefresh() {
        if (refreshInterval) return;
        refreshInterval = setInterval(() => {
            if (document.getElementById('queue-tab').style.display !== 'none') {
                // Use the PARTIAL endpoint that only returns queue items, not full page
                htmx.ajax('GET', '/downloads/queue-partial', { 
                    target: '#queue-tab', 
                    swap: 'innerHTML'
                });
            }
        }, 5000);
    }
    
    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }
    
    // Start auto-refresh on page load, stop when tab hidden
    document.addEventListener('DOMContentLoaded', () => {
        initScrollReveal();
        startAutoRefresh();
    });
    
    // Pause refresh when page is hidden (saves resources)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopAutoRefresh();
        } else {
            startAutoRefresh();
        }
    });
</script>
{% endblock %}