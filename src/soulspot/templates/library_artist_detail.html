{# Hey future me - Artist detail page!
   Shows artist image from Spotify (image_url) or letter fallback.
   Album grid now shows artwork_url from Spotify CDN if available.
   Tracks table has status badges and edit buttons. #}

{% extends "base.html" %}

{% block title %}{{ artist.name }} - Artists - SoulSpot{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav style="margin-bottom: var(--space-4);">
    <ol style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-size-sm); list-style: none; padding: 0; margin: 0;">
        <li><a href="/library" style="color: var(--accent-primary);">Library</a></li>
        <li style="color: var(--text-muted);"><i class="bi bi-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i></li>
        <li><a href="/library/artists" style="color: var(--accent-primary);">Artists</a></li>
        <li style="color: var(--text-muted);"><i class="bi bi-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i>{{ artist.name }}</li>
    </ol>
</nav>

<!-- Artist Header -->
<div style="display: flex; align-items: center; gap: var(--space-6); margin-bottom: var(--space-8);">
    {# ImageService provides SVG placeholder if no image #}
    <div class="artist-avatar-large">
        <img src="{{ get_display_url(artist.image_url, artist.image_path, 'artist') }}" alt="{{ artist.name }}" loading="lazy" style="width: 100%; height: 100%; object-fit: cover; border-radius: inherit;">
    </div>
    <div>
        <h1 style="font-size: var(--font-size-3xl); margin-bottom: var(--space-2);">{{ artist.name }}</h1>
        {% if artist.disambiguation %}
        <div style="font-size: var(--font-size-sm); color: var(--text-muted); opacity: 0.7; margin-bottom: var(--space-2);">{{ artist.disambiguation }}</div>
        {% endif %}
        <div style="display: flex; gap: var(--space-4); color: var(--text-muted); font-size: var(--font-size-sm); margin-bottom: var(--space-3);">
            {# Hey future me - X/Y availability badge! Shows owned/total from discography.
               If discography not synced (total_albums=0), fall back to just showing count.
               Green = complete (X=Y), Orange = partial (X<Y) #}
            {% if artist.total_albums > 0 %}
            <span class="availability-badge {% if artist.owned_albums >= artist.total_albums %}availability-complete{% else %}availability-partial{% endif %}">
                <i class="bi bi-disc" style="margin-right: var(--space-2);"></i>{{ artist.owned_albums }}/{{ artist.total_albums }} album{{ 's' if artist.total_albums != 1 else '' }}
            </span>
            {% else %}
            <span><i class="bi bi-disc" style="margin-right: var(--space-2);"></i>{{ artist.albums|length }} album{{ 's' if artist.albums|length != 1 else '' }}</span>
            {% endif %}
            <span><i class="bi bi-music-note" style="margin-right: var(--space-2);"></i>{{ artist.track_count }} track{{ 's' if artist.track_count != 1 else '' }}</span>
        </div>
        {# Hey future me - External service links! MusicBrainz and Spotify. 
           These open in new tabs so users can explore metadata sources. #}
        <div style="display: flex; gap: var(--space-3); flex-wrap: wrap;">
            {% if artist.musicbrainz_id %}
            <a href="https://musicbrainz.org/artist/{{ artist.musicbrainz_id }}" 
               target="_blank" 
               rel="noopener noreferrer"
               class="external-link-badge musicbrainz"
               title="View on MusicBrainz">
                <i class="bi bi-box-arrow-up-right"></i> MusicBrainz
            </a>
            {% endif %}
            {% if artist.spotify_uri %}
            <a href="https://open.spotify.com/artist/{{ artist.spotify_uri.replace('spotify:artist:', '') }}" 
               target="_blank" 
               rel="noopener noreferrer"
               class="external-link-badge spotify"
               title="Open in Spotify">
                <i class="bi bi-spotify"></i> Spotify
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Albums Section - UNIFIED VIEW (owned + missing with availability badges) -->
{# Hey future me - UNIFIED album view! Shows ALL albums from artist_discography.
   Each album has:
   - Availability badge: "X/Y" tracks (green if complete, orange if partial, red if 0)
   - is_owned flag: determines if album is clickable to view tracks
   - Download button: shown for albums user doesn't have yet
   This replaces the old split "Albums" + "Missing from Collection" sections. #}
<div class="card" style="padding: var(--space-6); margin-bottom: var(--space-6);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-5);">
        <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); margin: 0;">
            <i class="bi bi-disc" style="color: var(--accent-primary); margin-right: var(--space-2);"></i>
            Discography
        </h2>
        <div style="display: flex; gap: var(--space-3); align-items: center;">
            {# Sync Discography Button - fetches ALL albums + tracks from providers #}
            <button id="sync-discography-btn"
                    onclick="syncDiscography('{{ artist.id }}')"
                    class="btn btn-outline btn-sm"
                    style="display: flex; align-items: center; gap: var(--space-2);"
                    title="Fetch complete discography (albums + tracks) from Spotify/Deezer">
                <i class="bi bi-cloud-download"></i>
                <span>Sync Discography</span>
            </button>
            {# Album type filter #}
            <select id="album-type-filter" 
                    style="padding: var(--space-2); border-radius: var(--radius-md); border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: var(--font-size-sm);"
                    onchange="filterAlbumsByType(this.value)">
                <option value="all" selected>All Types</option>
                <option value="album">Albums Only</option>
                <option value="ep">EPs Only</option>
                <option value="single">Singles Only</option>
                <option value="compilation">Compilations Only</option>
            </select>
        </div>
    </div>
    {% if artist.albums %}
    <div class="albums-grid" id="albums-grid">
        {% for album in artist.albums %}
        {# Hey future me - album card styling based on ownership status!
           - is_owned=True + tracks > 0: Clickable, normal styling
           - is_owned=True + tracks = 0: Clickable but grayed out (metadata only)
           - is_owned=False: Semi-transparent, shows download button #}
        <div class="album-card-wrapper" data-album-type="{{ album.primary_type|lower }}" style="{% if not album.is_owned %}opacity: 0.7;{% endif %}">
            {% if album.is_owned and album.track_count > 0 %}
            <a href="/library/albums/{{ album.id }}" class="album-card">
            {% else %}
            <div class="album-card" style="cursor: {% if album.is_owned %}pointer{% else %}default{% endif %};">
            {% endif %}
                <div class="album-cover">
                    <img src="{{ get_display_url(album.artwork_url, album.artwork_path, 'album') }}" alt="{{ album.title }}" loading="lazy">
                    {# Album type badge #}
                    <div class="album-type-badges">
                        {% if album.primary_type|lower == 'single' %}
                        <span class="album-type-badge album-type-single">Single</span>
                        {% elif album.primary_type|lower == 'ep' %}
                        <span class="album-type-badge album-type-ep">EP</span>
                        {% elif album.primary_type|lower == 'compilation' %}
                        <span class="album-type-badge album-type-compilation">Compilation</span>
                        {% else %}
                        <span class="album-type-badge album-type-album">Album</span>
                        {% endif %}
                    </div>
                    {# Download overlay for albums user doesn't have #}
                    {% if not album.is_owned %}
                    <div class="album-download-overlay" style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: var(--space-2); display: flex; justify-content: center;">
                        <a href="/search?q={{ (artist.name ~ ' ' ~ album.title)|urlencode }}" 
                           class="btn btn-primary btn-sm"
                           onclick="event.stopPropagation();"
                           title="Search to download">
                            <i class="bi bi-download"></i> Get
                        </a>
                    </div>
                    {% endif %}
                </div>
                <h3 class="album-title" title="{{ album.title }}">{{ album.title }}</h3>
                <div class="album-meta">
                    {# Hey future me - LOCAL availability badge showing X/Y tracks!
                       X = local_tracks (tracks with file_path = downloaded files)
                       Y = total_tracks (total tracks from provider)
                       - Green (complete): local_tracks >= total_tracks
                       - Orange (partial): local_tracks > 0 but < total_tracks
                       - Red (none): local_tracks = 0 #}
                    {% set local = album.local_tracks|default(0) %}
                    {% set total = album.total_tracks|default(0) %}
                    {% if total > 0 %}
                        {% if local >= total %}
                        <span class="availability-badge-small availability-complete" title="{{ local }} of {{ total }} tracks have local files">
                            <i class="bi bi-check-circle-fill"></i> {{ local }}/{{ total }} local
                        </span>
                        {% elif local > 0 %}
                        <span class="availability-badge-small availability-partial" title="{{ local }} of {{ total }} tracks have local files">
                            <i class="bi bi-music-note"></i> {{ local }}/{{ total }} local
                        </span>
                        {% else %}
                        <span class="availability-badge-small availability-none" style="background: var(--danger); color: white;" title="No local files yet">
                            <i class="bi bi-x-circle"></i> 0/{{ total }} local
                        </span>
                        {% endif %}
                    {% else %}
                        {# No total_tracks info - just show what we have locally #}
                        {% if local > 0 %}
                        <span title="{{ local }} tracks with local files"><i class="bi bi-music-note"></i> {{ local }} local</span>
                        {% else %}
                        <span class="availability-badge-small availability-none" style="background: var(--danger); color: white;" title="No local files">
                            <i class="bi bi-x-circle"></i> 0 local
                        </span>
                        {% endif %}
                    {% endif %}
                    {% if album.year %}<span>{{ album.year }}</span>{% endif %}
                </div>
            {% if album.is_owned and album.track_count > 0 %}
            </a>
            {% else %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state-small">
        <i class="bi bi-disc"></i>
        <p>No albums found. Run Library Discovery to fetch discography.</p>
        <a href="/settings/library" class="btn btn-primary btn-sm" style="margin-top: var(--space-3);">
            <i class="bi bi-search"></i> Library Settings
        </a>
    </div>
    {% endif %}
</div>

<script>
{# Hey future me - client-side filter for album types!
   Hides/shows album cards based on selected type. Fast, no server round-trip. #}
function filterAlbumsByType(type) {
    const cards = document.querySelectorAll('.album-card-wrapper');
    cards.forEach(card => {
        const cardType = card.dataset.albumType;
        if (type === 'all' || cardType === type) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}
</script>

<!-- Hey future me - All Tracks section removed Dec 2025!
     Tracks are already shown inside albums, so this was redundant.
     Users can click on an album to see all tracks in that album. -->

<!-- Metadata Modal Container -->
<div id="metadata-modal"></div>
{% endblock %}

{% block extra_scripts %}
<style>
    .artist-avatar-large {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
    }
    .artist-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .albums-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: var(--space-4);
    }
    .album-card {
        background: var(--bg-tertiary);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        text-decoration: none;
        color: var(--text-primary);
        transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    .album-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    .album-cover {
        aspect-ratio: 1;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: rgba(255, 255, 255, 0.4);
        overflow: hidden;
        position: relative;
    }
    .album-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    /* Hey future me - Multi-badge container! Stacks badges horizontally with gap.
       Position absolute so they overlay the album cover (top-left corner). */
    .album-type-badges {
        position: absolute;
        top: 6px;
        left: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        max-width: calc(100% - 12px);
        z-index: 5;
    }
    /* Individual badge styling */
    .album-type-badge {
        backdrop-filter: blur(8px);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
        white-space: nowrap;
    }
    /* Primary types */
    .album-type-single {
        background: rgba(59, 130, 246, 0.9);  /* Blue */
        color: white;
    }
    .album-type-ep {
        background: rgba(139, 92, 246, 0.9);  /* Purple */
        color: white;
    }
    .album-type-album {
        background: rgba(34, 197, 94, 0.9);  /* Green */
        color: white;
    }
    /* Secondary types */
    .album-type-compilation {
        background: rgba(245, 158, 11, 0.9);  /* Amber/Orange */
        color: white;
    }
    .album-type-live {
        background: rgba(239, 68, 68, 0.9);  /* Red */
        color: white;
    }
    .album-type-remix {
        background: rgba(236, 72, 153, 0.9);  /* Pink */
        color: white;
    }
    .album-type-soundtrack {
        background: rgba(168, 85, 247, 0.9);  /* Violet */
        color: white;
    }
    .album-type-other {
        background: rgba(107, 114, 128, 0.9);  /* Gray */
        color: white;
    }
    
    /* Hey future me - Availability badges for X/Y format (owned/total)!
       .availability-complete = green (user owns all)
       .availability-partial = orange (user missing some)
       Used for both artist albums and album tracks. */
    .availability-badge {
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
    }
    .availability-badge-small {
        font-size: var(--font-size-xs);
        display: inline-flex;
        align-items: center;
        gap: 2px;
    }
    .availability-complete {
        background: rgba(34, 197, 94, 0.15);  /* Green tint */
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }
    .availability-partial {
        background: rgba(245, 158, 11, 0.15);  /* Orange tint */
        color: var(--warning);
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .availability-none {
        background: rgba(239, 68, 68, 0.15);  /* Red tint */
        color: var(--danger, #ef4444);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    /* Album card wrapper for unified view */
    .album-card-wrapper {
        position: relative;
    }
    .album-cover {
        position: relative;
    }
    .album-download-overlay {
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .album-card-wrapper:hover .album-download-overlay {
        opacity: 1;
    }
    
    .album-title {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        margin-bottom: var(--space-1);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .album-meta {
        display: flex;
        justify-content: space-between;
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    .data-table th {
        padding: var(--space-3) var(--space-4);
        text-align: left;
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: var(--bg-tertiary);
    }
    .data-table td {
        padding: var(--space-3) var(--space-4);
        border-bottom: 1px solid var(--border-primary);
        font-size: var(--font-size-sm);
    }
    .data-table tr:hover {
        background: var(--bg-hover);
    }
    .empty-state-small {
        text-align: center;
        padding: var(--space-6);
        color: var(--text-muted);
    }
    .empty-state-small i {
        font-size: var(--font-size-3xl);
        margin-bottom: var(--space-3);
        display: block;
        opacity: 0.5;
    }
    /* Hey future me - External service link badges!
       MusicBrainz = yellow/orange (their brand color)
       Spotify = green (their brand color) */
    .external-link-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        text-decoration: none;
        transition: all var(--transition-fast);
    }
    .external-link-badge.musicbrainz {
        background: rgba(186, 83, 45, 0.15);
        color: #e69d3c;
        border: 1px solid rgba(186, 83, 45, 0.3);
    }
    .external-link-badge.musicbrainz:hover {
        background: rgba(186, 83, 45, 0.25);
        transform: translateY(-1px);
    }
    .external-link-badge.spotify {
        background: rgba(30, 215, 96, 0.15);
        color: #1ed760;
        border: 1px solid rgba(30, 215, 96, 0.3);
    }
    .external-link-badge.spotify:hover {
        background: rgba(30, 215, 96, 0.25);
        transform: translateY(-1px);
    }
</style>

<script>
// Hey future me - Sync Discography function!
// Calls POST /artists/{id}/sync-discography to fetch ALL albums + tracks from providers.
// Shows loading state on button, then reloads page to show new data.
async function syncDiscography(artistId) {
    const btn = document.getElementById('sync-discography-btn');
    const originalContent = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat spinning"></i> <span>Syncing...</span>';
    
    try {
        const response = await fetch(`/api/artists/${artistId}/sync-discography`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Sync failed');
        }
        
        const result = await response.json();
        
        // Show success message
        btn.innerHTML = '<i class="bi bi-check-circle"></i> <span>Done!</span>';
        btn.classList.add('btn-success');
        
        // Show toast notification
        if (window.showToast) {
            window.showToast(result.message, 'success');
        } else {
            console.log('Sync result:', result.message);
        }
        
        // Reload page after short delay to show new data
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('Discography sync failed:', error);
        
        // Show error state
        btn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> <span>Error</span>';
        btn.classList.add('btn-danger');
        
        if (window.showToast) {
            window.showToast(`Sync failed: ${error.message}`, 'error');
        } else {
            alert(`Sync failed: ${error.message}`);
        }
        
        // Reset button after delay
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalContent;
            btn.classList.remove('btn-danger');
        }, 3000);
    }
}

// Spinning animation for loading state
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .spinning {
        animation: spin 1s linear infinite;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
