{# Hey future me - Artist detail page!
   Shows artist image from Spotify (image_url) or letter fallback.
   Album grid now shows artwork_url from Spotify CDN if available.
   Tracks table has status badges and edit buttons. #}

{% extends "base.html" %}

{% block title %}{{ artist.name }} - Artists - SoulSpot{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav style="margin-bottom: var(--space-4);">
    <ol style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-size-sm); list-style: none; padding: 0; margin: 0;">
        <li><a href="/library" style="color: var(--accent-primary);">Library</a></li>
        <li style="color: var(--text-muted);"><i class="bi bi-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i></li>
        <li><a href="/library/artists" style="color: var(--accent-primary);">Artists</a></li>
        <li style="color: var(--text-muted);"><i class="bi bi-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i>{{ artist.name }}</li>
    </ol>
</nav>

<!-- Artist Header -->
<div style="display: flex; align-items: center; gap: var(--space-6); margin-bottom: var(--space-8);">
    {# ImageService provides SVG placeholder if no image #}
    <div class="artist-avatar-large">
        <img src="{{ get_display_url(artist.image_url, artist.image_path, 'artist') }}" alt="{{ artist.name }}" loading="lazy" style="width: 100%; height: 100%; object-fit: cover; border-radius: inherit;">
    </div>
    <div>
        <h1 style="font-size: var(--font-size-3xl); margin-bottom: var(--space-2);">{{ artist.name }}</h1>
        {% if artist.disambiguation %}
        <div style="font-size: var(--font-size-sm); color: var(--text-muted); opacity: 0.7; margin-bottom: var(--space-2);">{{ artist.disambiguation }}</div>
        {% endif %}
        <div style="display: flex; gap: var(--space-4); color: var(--text-muted); font-size: var(--font-size-sm); margin-bottom: var(--space-3);">
            {# Hey future me - X/Y availability badge! Shows owned/total from discography.
               If discography not synced (total_albums=0), fall back to just showing count.
               Green = complete (X=Y), Orange = partial (X<Y) #}
            {% if artist.total_albums > 0 %}
            <span class="availability-badge {% if artist.owned_albums >= artist.total_albums %}availability-complete{% else %}availability-partial{% endif %}">
                <i class="bi bi-disc" style="margin-right: var(--space-2);"></i>{{ artist.owned_albums }}/{{ artist.total_albums }} album{{ 's' if artist.total_albums != 1 else '' }}
            </span>
            {% else %}
            <span><i class="bi bi-disc" style="margin-right: var(--space-2);"></i>{{ artist.albums|length }} album{{ 's' if artist.albums|length != 1 else '' }}</span>
            {% endif %}
            <span><i class="bi bi-music-note" style="margin-right: var(--space-2);"></i>{{ artist.track_count }} track{{ 's' if artist.track_count != 1 else '' }}</span>
        </div>
        {# Hey future me - External service links! MusicBrainz and Spotify. 
           These open in new tabs so users can explore metadata sources. #}
        <div style="display: flex; gap: var(--space-3); flex-wrap: wrap;">
            {% if artist.musicbrainz_id %}
            <a href="https://musicbrainz.org/artist/{{ artist.musicbrainz_id }}" 
               target="_blank" 
               rel="noopener noreferrer"
               class="external-link-badge musicbrainz"
               title="View on MusicBrainz">
                <i class="bi bi-box-arrow-up-right"></i> MusicBrainz
            </a>
            {% endif %}
            {% if artist.spotify_uri %}
            <a href="https://open.spotify.com/artist/{{ artist.spotify_uri.replace('spotify:artist:', '') }}" 
               target="_blank" 
               rel="noopener noreferrer"
               class="external-link-badge spotify"
               title="Open in Spotify">
                <i class="bi bi-spotify"></i> Spotify
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Albums Section -->
<div class="card" style="padding: var(--space-6); margin-bottom: var(--space-6);">
    <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); margin-bottom: var(--space-5);">Albums</h2>
    {% if artist.albums %}
    <div class="albums-grid">
        {% for album in artist.albums %}
        <a href="/library/albums/{{ album.id }}" class="album-card">
            <div class="album-cover">
                {# ImageService provides: local cache > CDN > placeholder #}
                <img src="{{ get_display_url(album.artwork_url, album.artwork_path, 'album') }}" alt="{{ album.title }}" loading="lazy">
                {# Hey future me - Multi-badge system! Shows ALL relevant types (primary + secondary).
                   Examples: [Album], [EP] [Remix], [Album] [Live] [Compilation]
                   Badges stack horizontally, color-coded by type. #}
                <div class="album-type-badges">
                    {# Primary type badge - always show #}
                    {% if album.primary_type|lower == 'single' %}
                    <span class="album-type-badge album-type-single">Single</span>
                    {% elif album.primary_type|lower == 'ep' %}
                    <span class="album-type-badge album-type-ep">EP</span>
                    {% else %}
                    <span class="album-type-badge album-type-album">Album</span>
                    {% endif %}
                    
                    {# Secondary type badges - show all if present #}
                    {% if album.secondary_types %}
                        {% for secondary in album.secondary_types %}
                            {% set secondary_lower = secondary|lower %}
                            {% if secondary_lower == 'compilation' %}
                            <span class="album-type-badge album-type-compilation">Compilation</span>
                            {% elif secondary_lower == 'live' %}
                            <span class="album-type-badge album-type-live">Live</span>
                            {% elif secondary_lower == 'remix' %}
                            <span class="album-type-badge album-type-remix">Remix</span>
                            {% elif secondary_lower == 'soundtrack' %}
                            <span class="album-type-badge album-type-soundtrack">Soundtrack</span>
                            {% else %}
                            <span class="album-type-badge album-type-other">{{ secondary|title }}</span>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            <h3 class="album-title" title="{{ album.title }}">{{ album.title }}</h3>
            <div class="album-meta">
                {# Hey future me - X/Y track availability badge!
                   track_count = local tracks owned, total_tracks = from provider API.
                   If total_tracks not available, just show count. #}
                {% if album.total_tracks and album.total_tracks > 0 %}
                <span class="availability-badge-small {% if album.track_count >= album.total_tracks %}availability-complete{% else %}availability-partial{% endif %}">
                    <i class="bi bi-music-note"></i> {{ album.track_count }}/{{ album.total_tracks }}
                </span>
                {% else %}
                <span><i class="bi bi-music-note"></i> {{ album.track_count }}</span>
                {% endif %}
                {% if album.year %}<span>{{ album.year }}</span>{% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state-small">
        <i class="bi bi-disc"></i>
        <p>No albums found for this artist.</p>
    </div>
    {% endif %}
</div>

<!-- Missing Albums Section (from discography discovery) -->
{# Hey future me - diese Section zeigt Alben die der User NICHT hat!
   Geladen via HTMX von /api/library/discovery/missing/{artist_id}.
   Nur anzeigen wenn der Artist eine ID hat (sonst wurde noch keine Discovery gemacht).
   Die Karten haben Download-Buttons die zur Search mit artist+album title f√ºhren.
   Filter: album_types kann album,ep,single,compilation sein (Default: alle) #}
<div class="card" style="padding: var(--space-6); margin-bottom: var(--space-6);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
        <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); margin: 0;">
            <i class="bi bi-collection" style="color: var(--accent-secondary); margin-right: var(--space-2);"></i>
            Missing from Collection
        </h2>
        <div style="display: flex; gap: var(--space-2); align-items: center;">
            {# Album type filter #}
            <select id="missing-album-types" 
                    style="padding: var(--space-2); border-radius: var(--radius-md); border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: var(--font-size-sm);"
                    onchange="refreshMissingAlbums()">
                <option value="album,ep,single,compilation" selected>All Types</option>
                <option value="album,ep">Albums & EPs</option>
                <option value="album">Albums Only</option>
                <option value="single">Singles Only</option>
                <option value="compilation">Compilations Only</option>
            </select>
            <button class="btn btn-ghost btn-sm" 
                    onclick="refreshMissingAlbums()"
                    title="Refresh">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>
    
    <div id="missing-albums-loading" class="htmx-indicator" style="text-align: center; padding: var(--space-4);">
        <i class="bi bi-arrow-repeat spin" style="font-size: 1.5rem;"></i>
        <span style="margin-left: var(--space-2);">Loading discography...</span>
    </div>
    
    <div id="missing-albums-container"
         hx-get="/api/library/discovery/missing/{{ artist.id }}?album_types=album,ep,single,compilation"
         hx-trigger="load"
         hx-swap="innerHTML">
        <!-- Content loaded via HTMX -->
    </div>
</div>

<script>
function refreshMissingAlbums() {
    const types = document.getElementById('missing-album-types').value;
    const container = document.getElementById('missing-albums-container');
    htmx.ajax('GET', '/api/library/discovery/missing/{{ artist.id }}?album_types=' + types, {target: container, swap: 'innerHTML'});
}
</script>

<!-- Hey future me - All Tracks section removed Dec 2025!
     Tracks are already shown inside albums, so this was redundant.
     Users can click on an album to see all tracks in that album. -->

<!-- Metadata Modal Container -->
<div id="metadata-modal"></div>
{% endblock %}

{% block extra_scripts %}
<style>
    .artist-avatar-large {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
    }
    .artist-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .albums-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: var(--space-4);
    }
    .album-card {
        background: var(--bg-tertiary);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        text-decoration: none;
        color: var(--text-primary);
        transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    .album-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    .album-cover {
        aspect-ratio: 1;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: rgba(255, 255, 255, 0.4);
        overflow: hidden;
        position: relative;
    }
    .album-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    /* Hey future me - Multi-badge container! Stacks badges horizontally with gap.
       Position absolute so they overlay the album cover (top-left corner). */
    .album-type-badges {
        position: absolute;
        top: 6px;
        left: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        max-width: calc(100% - 12px);
        z-index: 5;
    }
    /* Individual badge styling */
    .album-type-badge {
        backdrop-filter: blur(8px);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
        white-space: nowrap;
    }
    /* Primary types */
    .album-type-single {
        background: rgba(59, 130, 246, 0.9);  /* Blue */
        color: white;
    }
    .album-type-ep {
        background: rgba(139, 92, 246, 0.9);  /* Purple */
        color: white;
    }
    .album-type-album {
        background: rgba(34, 197, 94, 0.9);  /* Green */
        color: white;
    }
    /* Secondary types */
    .album-type-compilation {
        background: rgba(245, 158, 11, 0.9);  /* Amber/Orange */
        color: white;
    }
    .album-type-live {
        background: rgba(239, 68, 68, 0.9);  /* Red */
        color: white;
    }
    .album-type-remix {
        background: rgba(236, 72, 153, 0.9);  /* Pink */
        color: white;
    }
    .album-type-soundtrack {
        background: rgba(168, 85, 247, 0.9);  /* Violet */
        color: white;
    }
    .album-type-other {
        background: rgba(107, 114, 128, 0.9);  /* Gray */
        color: white;
    }
    
    /* Hey future me - Availability badges for X/Y format (owned/total)!
       .availability-complete = green (user owns all)
       .availability-partial = orange (user missing some)
       Used for both artist albums and album tracks. */
    .availability-badge {
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
    }
    .availability-badge-small {
        font-size: var(--font-size-xs);
        display: inline-flex;
        align-items: center;
        gap: 2px;
    }
    .availability-complete {
        background: rgba(34, 197, 94, 0.15);  /* Green tint */
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }
    .availability-partial {
        background: rgba(245, 158, 11, 0.15);  /* Orange tint */
        color: var(--warning);
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .album-title {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        margin-bottom: var(--space-1);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .album-meta {
        display: flex;
        justify-content: space-between;
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    .data-table th {
        padding: var(--space-3) var(--space-4);
        text-align: left;
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: var(--bg-tertiary);
    }
    .data-table td {
        padding: var(--space-3) var(--space-4);
        border-bottom: 1px solid var(--border-primary);
        font-size: var(--font-size-sm);
    }
    .data-table tr:hover {
        background: var(--bg-hover);
    }
    .empty-state-small {
        text-align: center;
        padding: var(--space-6);
        color: var(--text-muted);
    }
    .empty-state-small i {
        font-size: var(--font-size-3xl);
        margin-bottom: var(--space-3);
        display: block;
        opacity: 0.5;
    }
    /* Hey future me - External service link badges!
       MusicBrainz = yellow/orange (their brand color)
       Spotify = green (their brand color) */
    .external-link-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        text-decoration: none;
        transition: all var(--transition-fast);
    }
    .external-link-badge.musicbrainz {
        background: rgba(186, 83, 45, 0.15);
        color: #e69d3c;
        border: 1px solid rgba(186, 83, 45, 0.3);
    }
    .external-link-badge.musicbrainz:hover {
        background: rgba(186, 83, 45, 0.25);
        transform: translateY(-1px);
    }
    .external-link-badge.spotify {
        background: rgba(30, 215, 96, 0.15);
        color: #1ed760;
        border: 1px solid rgba(30, 215, 96, 0.3);
    }
    .external-link-badge.spotify:hover {
        background: rgba(30, 215, 96, 0.25);
        transform: translateY(-1px);
    }
</style>
{% endblock %}
