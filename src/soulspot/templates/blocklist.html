{# Hey future me - Blocklist Management Page!
   
   This page shows blocked Soulseek sources.
   
   Features:
   - List active blocks (users/files)
   - Add manual blocks
   - Remove blocks
   - View expired blocks (history)
   - Clear expired blocks
   
   Block scopes:
   - USERNAME: Block all files from a user
   - FILEPATH: Block a specific file from anyone
   - SPECIFIC: Block exact user+file combination
   
   Integration:
   - API: /api/blocklist
   - Auto-populated by: DownloadService on failures
   - Used by: SearchService to filter results
#}

{% extends "base.html" %}

{% block title %}Blocklist - SoulSpot{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="header-content">
        <div class="header-icon-wrapper">
            <div class="header-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <i class="bi bi-ban vinyl-record-icon"></i>
            </div>
            <div class="header-icon-glow" style="background: radial-gradient(circle, rgba(239, 68, 68, 0.3) 0%, transparent 70%);"></div>
        </div>
        <div>
            <h1>Blocklist</h1>
            <p class="subtitle">Manage blocked Soulseek sources</p>
        </div>
    </div>
    <div class="header-actions">
        <button class="btn btn-outline" onclick="loadExpired()" id="show-expired-btn">
            <i class="bi bi-clock-history"></i>
            Show Expired
        </button>
        <button class="btn btn-primary" onclick="showAddModal()">
            <i class="bi bi-plus-lg"></i>
            Add Block
        </button>
    </div>
</div>

<!-- Info Banner -->
<div class="alert alert-info mb-6 blur-fade-in">
    <i class="bi bi-info-circle-fill"></i>
    <span>
        Blocked sources are automatically skipped during search. 
        <strong>Auto-blocks</strong> are added when downloads fail repeatedly.
        <strong>Manual blocks</strong> can be added for known problematic sources.
    </span>
</div>

<!-- Stats Cards -->
<div class="stats-grid mb-6">
    <div class="stat-card stat-card-animated blur-fade-in hover-glow delay-0">
        <div class="stat-icon stat-icon-error">
            <i class="bi bi-ban"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="stat-active">-</span>
            <span class="stat-label">Active Blocks</span>
        </div>
    </div>

    <div class="stat-card stat-card-animated blur-fade-in hover-glow delay-1">
        <div class="stat-icon stat-icon-warning">
            <i class="bi bi-person-x"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="stat-users">-</span>
            <span class="stat-label">Blocked Users</span>
        </div>
    </div>

    <div class="stat-card stat-card-animated blur-fade-in hover-glow delay-2">
        <div class="stat-icon stat-icon-info">
            <i class="bi bi-hand-thumbs-up"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="stat-manual">-</span>
            <span class="stat-label">Manual Blocks</span>
        </div>
    </div>

    <div class="stat-card stat-card-animated blur-fade-in hover-glow delay-3">
        <div class="stat-icon stat-icon-muted">
            <i class="bi bi-clock-history"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="stat-expired">-</span>
            <span class="stat-label">Expired</span>
        </div>
    </div>
</div>

<!-- Blocklist Table -->
<div class="card" id="blocklist-container">
    <div class="card-header">
        <h3 id="list-title">Active Blocks</h3>
        <button class="btn btn-sm btn-outline" onclick="loadActive()" title="Refresh">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>
    <div class="card-body">
        <div class="loading-placeholder" id="loading-indicator">
            <div class="spinner"></div>
            <p>Loading blocklist...</p>
        </div>
        <div id="blocklist-content" style="display: none;">
            <!-- Populated by JS -->
        </div>
    </div>
</div>

<!-- Add Block Modal -->
<div id="add-modal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Add Block</h2>
            <button class="modal-close" onclick="closeModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="add-form" onsubmit="addBlock(event)">
                <!-- Username -->
                <div class="form-group">
                    <label class="form-label" for="block-username">Soulseek Username</label>
                    <input type="text" id="block-username" class="form-input"
                           placeholder="e.g., slowUser123">
                    <p class="form-helper">Block all files from this user</p>
                </div>
                
                <!-- Filepath -->
                <div class="form-group">
                    <label class="form-label" for="block-filepath">File Path</label>
                    <input type="text" id="block-filepath" class="form-input"
                           placeholder="e.g., @@someUser\Music\track.mp3">
                    <p class="form-helper">Block this specific file path</p>
                </div>
                
                <div class="alert alert-warning" style="margin-bottom: var(--space-4);">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span>Provide username, filepath, or both. At least one is required.</span>
                </div>
                
                <!-- Reason -->
                <div class="form-group">
                    <label class="form-label" for="block-reason">Reason</label>
                    <input type="text" id="block-reason" class="form-input"
                           placeholder="e.g., Always times out" value="Manual block">
                </div>
                
                <!-- Expiry -->
                <div class="form-group">
                    <label class="form-label" for="block-expires">Expires After</label>
                    <select id="block-expires" class="form-input">
                        <option value="">Permanent</option>
                        <option value="7">7 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="90">90 days</option>
                        <option value="365">1 year</option>
                    </select>
                    <p class="form-helper">When the block should expire</p>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
            <button type="submit" form="add-form" class="btn btn-danger">
                <i class="bi bi-ban"></i>
                Add Block
            </button>
        </div>
    </div>
</div>

<style>
/* Blocklist Table */
.blocklist-table {
    width: 100%;
    border-collapse: collapse;
}

.blocklist-table th,
.blocklist-table td {
    padding: var(--space-3);
    text-align: left;
    border-bottom: 1px solid var(--border-primary);
}

.blocklist-table th {
    font-weight: var(--font-weight-semibold);
    color: var(--text-muted);
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.blocklist-table tr:hover {
    background: var(--bg-tertiary);
}

.blocklist-source {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.blocklist-username {
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.blocklist-filepath {
    font-family: var(--font-mono);
    font-size: var(--font-size-xs);
    color: var(--text-muted);
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.blocklist-meta {
    font-size: var(--font-size-sm);
    color: var(--text-muted);
}

.blocklist-actions {
    display: flex;
    gap: var(--space-2);
}

/* Scope Badges */
.scope-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
}

.scope-badge.username {
    background: rgba(239, 68, 68, 0.2);
    color: #f87171;
}

.scope-badge.filepath {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
}

.scope-badge.specific {
    background: rgba(139, 92, 246, 0.2);
    color: #a78bfa;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: var(--space-8);
    color: var(--text-muted);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: var(--space-4);
    opacity: 0.5;
}

/* Loading Placeholder */
.loading-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-8);
    color: var(--text-muted);
}
</style>

<script>
// Hey future me - Blocklist UI JS!

let activeEntries = [];
let expiredEntries = [];
let showingExpired = false;

// Load active blocks on page load
document.addEventListener('DOMContentLoaded', () => {
    loadActive();
    loadExpiredCount();
});

async function loadActive() {
    showingExpired = false;
    document.getElementById('list-title').textContent = 'Active Blocks';
    document.getElementById('show-expired-btn').innerHTML = '<i class="bi bi-clock-history"></i> Show Expired';
    
    document.getElementById('loading-indicator').style.display = 'flex';
    document.getElementById('blocklist-content').style.display = 'none';
    
    try {
        const response = await fetch('/api/blocklist');
        const data = await response.json();
        activeEntries = data.entries || [];
        
        updateStats();
        renderEntries(activeEntries);
        
    } catch (error) {
        console.error('Failed to load blocklist:', error);
        showNotification('Failed to load blocklist', 'error');
    }
}

async function loadExpired() {
    if (showingExpired) {
        loadActive();
        return;
    }
    
    showingExpired = true;
    document.getElementById('list-title').textContent = 'Expired Blocks';
    document.getElementById('show-expired-btn').innerHTML = '<i class="bi bi-arrow-left"></i> Back to Active';
    
    document.getElementById('loading-indicator').style.display = 'flex';
    document.getElementById('blocklist-content').style.display = 'none';
    
    try {
        const response = await fetch('/api/blocklist/expired');
        const data = await response.json();
        expiredEntries = data.entries || [];
        
        renderEntries(expiredEntries, true);
        
    } catch (error) {
        console.error('Failed to load expired blocks:', error);
        showNotification('Failed to load expired blocks', 'error');
    }
}

async function loadExpiredCount() {
    try {
        const response = await fetch('/api/blocklist/expired?limit=1000');
        const data = await response.json();
        document.getElementById('stat-expired').textContent = data.total || 0;
    } catch (error) {
        console.error('Failed to load expired count:', error);
    }
}

function updateStats() {
    document.getElementById('stat-active').textContent = activeEntries.length;
    
    // Count blocked users
    const users = new Set(activeEntries.filter(e => e.username).map(e => e.username));
    document.getElementById('stat-users').textContent = users.size;
    
    // Count manual blocks
    const manual = activeEntries.filter(e => e.is_manual).length;
    document.getElementById('stat-manual').textContent = manual;
}

function renderEntries(entries, isExpired = false) {
    const content = document.getElementById('blocklist-content');
    const loading = document.getElementById('loading-indicator');
    
    loading.style.display = 'none';
    content.style.display = 'block';
    
    if (entries.length === 0) {
        content.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-check-circle"></i>
                <h3>${isExpired ? 'No Expired Blocks' : 'No Active Blocks'}</h3>
                <p>${isExpired ? 'All blocks are still active' : 'No sources are currently blocked'}</p>
            </div>
        `;
        return;
    }
    
    content.innerHTML = `
        <table class="blocklist-table">
            <thead>
                <tr>
                    <th>Source</th>
                    <th>Scope</th>
                    <th>Reason</th>
                    <th>Blocked</th>
                    <th>Expires</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${entries.map(entry => `
                    <tr>
                        <td>
                            <div class="blocklist-source">
                                ${entry.username ? `
                                    <span class="blocklist-username">
                                        <i class="bi bi-person"></i>
                                        ${escapeHtml(entry.username)}
                                    </span>
                                ` : ''}
                                ${entry.filepath ? `
                                    <span class="blocklist-filepath" title="${escapeHtml(entry.filepath)}">
                                        ${escapeHtml(entry.filepath)}
                                    </span>
                                ` : ''}
                            </div>
                        </td>
                        <td>
                            <span class="scope-badge ${entry.scope}">
                                ${entry.scope === 'username' ? '<i class="bi bi-person-x"></i> User' : 
                                  entry.scope === 'filepath' ? '<i class="bi bi-file-x"></i> File' :
                                  '<i class="bi bi-bullseye"></i> Specific'}
                            </span>
                        </td>
                        <td class="blocklist-meta">
                            ${escapeHtml(entry.reason || '-')}
                            ${entry.failure_count > 0 ? `<br><small>${entry.failure_count} failures</small>` : ''}
                        </td>
                        <td class="blocklist-meta">
                            ${formatDate(entry.blocked_at)}
                            ${entry.is_manual ? '<br><span class="badge badge-info">Manual</span>' : ''}
                        </td>
                        <td class="blocklist-meta">
                            ${entry.expires_at ? formatDate(entry.expires_at) : '<em>Never</em>'}
                            ${entry.is_expired ? '<br><span class="badge badge-warning">Expired</span>' : ''}
                        </td>
                        <td class="blocklist-actions">
                            <button class="btn btn-sm btn-danger-outline" 
                                    onclick="removeBlock('${entry.id}')" 
                                    title="Remove block">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        
        ${isExpired ? `
            <div style="margin-top: var(--space-4); text-align: right;">
                <button class="btn btn-outline btn-warning" onclick="clearExpired()">
                    <i class="bi bi-trash"></i>
                    Clear All Expired
                </button>
            </div>
        ` : ''}
    `;
}

function showAddModal() {
    document.getElementById('add-form').reset();
    document.getElementById('add-modal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    document.getElementById('add-modal').style.display = 'none';
    document.body.style.overflow = '';
}

async function addBlock(event) {
    event.preventDefault();
    
    const username = document.getElementById('block-username').value.trim() || null;
    const filepath = document.getElementById('block-filepath').value.trim() || null;
    const reason = document.getElementById('block-reason').value.trim() || 'Manual block';
    const expiresDays = document.getElementById('block-expires').value || null;
    
    if (!username && !filepath) {
        showNotification('Please provide username or filepath', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/blocklist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username,
                filepath,
                reason,
                expires_days: expiresDays ? parseInt(expiresDays) : null
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to add block');
        }
        
        showNotification('Block added successfully', 'success');
        closeModal();
        loadActive();
        
    } catch (error) {
        console.error('Add block error:', error);
        showNotification(error.message, 'error');
    }
}

async function removeBlock(id) {
    if (!confirm('Remove this block? The source will be available for downloads again.')) return;
    
    try {
        const response = await fetch(`/api/blocklist/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to remove block');
        
        showNotification('Block removed', 'success');
        
        if (showingExpired) {
            loadExpired();
        } else {
            loadActive();
        }
        loadExpiredCount();
        
    } catch (error) {
        console.error('Remove block error:', error);
        showNotification(error.message, 'error');
    }
}

async function clearExpired() {
    if (!confirm('Clear all expired blocks? This cannot be undone.')) return;
    
    try {
        const response = await fetch('/api/blocklist/clear-expired', {
            method: 'POST'
        });
        
        if (!response.ok) throw new Error('Failed to clear expired blocks');
        
        const data = await response.json();
        showNotification(`Cleared ${data.deleted_count} expired blocks`, 'success');
        
        loadExpired();
        loadExpiredCount();
        
    } catch (error) {
        console.error('Clear expired error:', error);
        showNotification(error.message, 'error');
    }
}

function formatDate(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleDateString('de-DE', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close modal on Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
});
</script>
{% endblock %}
