{#
Provider Health Widget for Download Manager

Hey future me – this shows the connection status to slskd and other
download providers. The circuit breaker states map to colors:
- closed (healthy) → green
- half_open (testing) → yellow  
- open (down) → red

This is included in download_manager.html and auto-refreshes every 10s.
#}

<div class="provider-health-widget">
    {% if providers %}
        {% for provider in providers %}
        <div class="provider-status flex items-center gap-2 p-2 rounded-lg
                    {% if provider.is_healthy %}
                        bg-green-900/20 border border-green-700/30
                    {% elif provider.circuit_state == 'half_open' %}
                        bg-yellow-900/20 border border-yellow-700/30
                    {% else %}
                        bg-red-900/20 border border-red-700/30
                    {% endif %}">
            
            {# Status indicator dot #}
            <div class="status-indicator w-3 h-3 rounded-full
                        {% if provider.is_healthy %}
                            bg-green-500 animate-pulse
                        {% elif provider.circuit_state == 'half_open' %}
                            bg-yellow-500 animate-pulse
                        {% else %}
                            bg-red-500
                        {% endif %}">
            </div>
            
            {# Provider info #}
            <div class="flex-1">
                <div class="font-medium text-sm text-gray-200">
                    {{ provider.provider_name }}
                </div>
                
                <div class="text-xs text-gray-400">
                    {% if provider.is_healthy %}
                        Connected
                        {% if provider.seconds_since_last_sync is not none %}
                            • Last sync {{ provider.seconds_since_last_sync }}s ago
                        {% endif %}
                    {% elif provider.circuit_state == 'half_open' %}
                        Testing connection...
                    {% elif provider.circuit_state == 'open' %}
                        Disconnected
                        {% if provider.consecutive_failures > 0 %}
                            ({{ provider.consecutive_failures }} failures)
                        {% endif %}
                        {% if provider.seconds_until_recovery_attempt is not none %}
                            • Retry in {{ provider.seconds_until_recovery_attempt }}s
                        {% endif %}
                    {% elif provider.error_message %}
                        {{ provider.error_message }}
                    {% else %}
                        Unknown status
                    {% endif %}
                </div>
            </div>
            
            {# Action button for unhealthy providers #}
            {% if not provider.is_healthy and provider.circuit_state != 'half_open' %}
            <button class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 
                          rounded text-gray-300 transition-colors"
                    hx-post="/api/downloads/manager/provider/{{ provider.provider }}/reconnect"
                    hx-target="#provider-health-container"
                    hx-swap="innerHTML">
                Retry
            </button>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div class="text-gray-500 text-sm">
            No providers configured
        </div>
    {% endif %}
    
    {# Overall status summary #}
    {% if providers %}
    <div class="mt-2 pt-2 border-t border-gray-700/50 text-xs text-gray-500">
        {% if overall_healthy %}
            <span class="text-green-400">✓</span> All providers connected
        {% else %}
            <span class="text-yellow-400">⚠</span> Some providers offline
        {% endif %}
    </div>
    {% endif %}
</div>
