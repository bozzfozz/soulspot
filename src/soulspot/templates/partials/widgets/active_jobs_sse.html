{# Active Jobs Widget with SSE - Shows active download jobs with real-time SSE updates #}
<div class="widget-content" id="active-jobs-widget-{{ instance_id|default('default') }}" 
     data-widget-type="active-jobs"
     data-sse-enabled="true">
  
  <div class="widget-header">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Active Jobs</h3>
    <span class="text-sm text-gray-500 dark:text-gray-400">
      <span id="jobs-count-{{ instance_id|default('default') }}">{{ jobs_count|default(0) }}</span> active
    </span>
  </div>
  
  <div id="jobs-list-{{ instance_id|default('default') }}" class="widget-body space-y-3 mt-4">
    {% if jobs and jobs|length > 0 %}
      {% for job in jobs[:5] %}
        <div class="job-item p-3 bg-gray-50 dark:bg-gray-800 rounded-lg" data-job-id="{{ job.id }}">
          <div class="flex items-center justify-between mb-2">
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                {{ job.title|default('Unknown Track') }}
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
                {{ job.artist|default('Unknown Artist') }}
              </p>
            </div>
            <span class="ml-2 px-2 py-1 text-xs font-medium rounded job-status
                         {% if job.status == 'downloading' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300
                         {% elif job.status == 'queued' %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300
                         {% elif job.status == 'completed' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300
                         {% elif job.status == 'failed' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300
                         {% endif %}">
              {{ job.status|title }}
            </span>
          </div>
          
          {% if job.status == 'downloading' %}
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div class="bg-blue-600 dark:bg-blue-500 h-2 rounded-full transition-all job-progress" 
                   style="width: {{ job.progress_percent|default(0) }}%"></div>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 job-progress-text">
              {{ job.progress_percent|default(0)|round(1) }}% complete
            </p>
          {% endif %}
          
          <div class="flex gap-2 mt-2">
            {% if job.status == 'downloading' %}
              <button class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600"
                      hx-post="/api/downloads/{{ job.id }}/pause"
                      hx-target="closest .job-item"
                      hx-swap="outerHTML">
                Pause
              </button>
            {% elif job.status == 'queued' or job.status == 'failed' %}
              <button class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
                      hx-post="/api/downloads/{{ job.id }}/resume"
                      hx-target="closest .job-item"
                      hx-swap="outerHTML">
                Resume
              </button>
            {% endif %}
            <button class="text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600"
                    hx-delete="/api/downloads/{{ job.id }}"
                    hx-confirm="Cancel this download?"
                    hx-target="closest .job-item"
                    hx-swap="outerHTML swap:300ms">
              Cancel
            </button>
          </div>
        </div>
      {% endfor %}
      
      {% if jobs|length > 5 %}
        <a href="/ui/downloads" class="block text-center text-sm text-blue-600 dark:text-blue-400 hover:underline mt-2">
          View all {{ jobs|length }} jobs â†’
        </a>
      {% endif %}
    {% else %}
      <div class="text-center py-8 text-gray-500 dark:text-gray-400" id="no-jobs-message-{{ instance_id|default('default') }}">
        <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="mt-2 text-sm">No active downloads</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
(function() {
  // Initialize SSE for active jobs widget
  const widgetId = '{{ instance_id|default("default") }}';
  const widget = document.getElementById('active-jobs-widget-' + widgetId);
  
  if (!widget || !widget.dataset.sseEnabled) {
    return; // Widget not found or SSE not enabled
  }

  // Check if SSEClient is available
  if (typeof SSEClient === 'undefined') {
    console.error('[ActiveJobsWidget] SSEClient not loaded');
    return;
  }

  // Create SSE client
  const sseClient = new SSEClient('/api/ui/sse/stream', {
    debug: {{ 'true' if config.get('debug') else 'false' }},
    reconnectInterval: 3000,
    maxReconnectAttempts: 10
  });

  // Handle downloads update
  sseClient.on('downloads_update', function(data) {
    console.log('[ActiveJobsWidget] Downloads update received', data);
    
    const jobsList = document.getElementById('jobs-list-' + widgetId);
    const jobsCount = document.getElementById('jobs-count-' + widgetId);
    
    if (!jobsList || !jobsCount) return;

    // Update count
    jobsCount.textContent = data.total_count || 0;

    // Update jobs list
    if (data.downloads && data.downloads.length > 0) {
      // Update existing jobs or add new ones
      data.downloads.forEach(function(download) {
        const existingJob = jobsList.querySelector('[data-job-id="' + download.id + '"]');
        
        if (existingJob) {
          // Update existing job
          const statusElement = existingJob.querySelector('.job-status');
          const progressBar = existingJob.querySelector('.job-progress');
          const progressText = existingJob.querySelector('.job-progress-text');
          
          if (statusElement) {
            statusElement.textContent = download.status.charAt(0).toUpperCase() + download.status.slice(1);
          }
          
          if (progressBar && download.status === 'downloading') {
            progressBar.style.width = (download.progress_percent || 0) + '%';
          }
          
          if (progressText && download.status === 'downloading') {
            progressText.textContent = (download.progress_percent || 0).toFixed(1) + '% complete';
          }
        }
      });
      
      // Hide "no jobs" message if present
      const noJobsMsg = document.getElementById('no-jobs-message-' + widgetId);
      if (noJobsMsg) {
        noJobsMsg.style.display = 'none';
      }
    } else {
      // Show "no jobs" message
      const noJobsMsg = document.getElementById('no-jobs-message-' + widgetId);
      if (noJobsMsg) {
        noJobsMsg.style.display = 'block';
      }
    }
  });

  // Handle connection status
  sseClient.on('connected', function() {
    console.log('[ActiveJobsWidget] SSE connected');
    widget.classList.remove('widget-disconnected');
    widget.classList.add('widget-connected');
  });

  sseClient.on('error', function() {
    console.error('[ActiveJobsWidget] SSE error');
    widget.classList.remove('widget-connected');
    widget.classList.add('widget-disconnected');
  });

  // Connect
  sseClient.connect();

  // Cleanup on page unload
  window.addEventListener('beforeunload', function() {
    sseClient.disconnect();
  });

  // Store client reference for potential debugging
  widget._sseClient = sseClient;
})();
</script>
