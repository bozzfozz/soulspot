{# Hey future me - UNIFIED Music Manager Artists Page!
   Shows ALL artists from the unified library (local files + cloud services).
   No source badges - just shows local/total counts for albums and tracks.
   X/Y format means "X verf端gbar (mit files) von Y gesamt".
   image_url comes from streaming CDN via artist.image_url. Fallback to first letter if no image. #}

{% extends "base.html" %}

{% block title %}Artists - SoulSpot{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav style="margin-bottom: var(--space-4);">
    <ol style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-size-sm); list-style: none; padding: 0; margin: 0;">
        <li><a href="/library" style="color: var(--accent-primary);">Library</a></li>
        <li style="color: var(--text-muted);"><i class="bi bi-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i>Artists</li>
    </ol>
</nav>

<!-- Page Header -->
<div class="page-header" style="margin-bottom: var(--space-6);">
    <div class="header-content">
        <div class="header-icon-wrapper">
            <div class="header-icon" style="background: linear-gradient(135deg, #a855f7, #7c3aed);">
                <i class="bi bi-people-fill vinyl-record-icon"></i>
            </div>
            <div class="header-icon-glow" style="background: radial-gradient(circle, rgba(168, 85, 247, 0.3) 0%, transparent 70%);"></div>
        </div>
        <div>
            <h1>Artists</h1>
            <p class="subtitle">{{ source_counts.all }} artists in your music manager</p>
        </div>
    </div>
    <div class="header-actions" style="display: flex; gap: var(--space-3); align-items: center;">
        <input type="text" 
               id="artist-search"
               placeholder="Search artists..."
               class="form-input"
               style="min-width: 220px;">
    </div>
</div>

<!-- Enrichment Banner - shows when artists need artwork -->
{% if enrichment_needed %}
<div id="enrichment-banner" class="enrichment-banner blur-fade-in">
    <div class="enrichment-banner-content">
        <div class="enrichment-banner-icon">
            <i class="bi bi-image"></i>
        </div>
        <div class="enrichment-banner-text">
            <strong>
                {{ artists_without_image }} artist{{ 's' if artists_without_image != 1 else '' }} +
                {{ albums_without_cover }} album{{ 's' if albums_without_cover != 1 else '' }} missing artwork
            </strong>
            <span>Click to fetch artist images and album covers</span>
        </div>
        <button id="enrich-btn" 
                class="btn btn-primary btn-sm"
                hx-post="/api/enrichment/trigger"
                hx-swap="none"
                hx-on::after-request="startEnrichmentPolling()">
            <i class="bi bi-cloud-download"></i>
            Fetch Artwork
        </button>
    </div>
    <div id="enrichment-progress" class="enrichment-progress" style="display: none;">
        <div class="enrichment-progress-bar">
            <div class="enrichment-progress-fill"></div>
        </div>
        <span class="enrichment-progress-text">Enriching...</span>
    </div>
</div>
{% endif %}

<!-- Artists Grid -->
<div id="artists-list">
    {% if artists %}
    <div class="artists-grid">
        {% for artist in artists %}
        <a href="/library/artists/{{ artist.name|urlencode }}" class="artist-card blur-fade-in hover-scale-interactive" style="--delay: {{ loop.index0 % 12 }};">
            {# ImageService provides SVG placeholder if no image #}
            <div class="artist-avatar">
                <img src="{{ get_display_url(artist.image_url, artist.image_path, 'artist') }}" alt="{{ artist.name }}" loading="lazy">
            </div>
            <h3 class="artist-name" title="{{ artist.name }}{% if artist.disambiguation %} ({{ artist.disambiguation }}){% endif %}">{{ artist.name }}</h3>
            {% if artist.disambiguation %}
            <div class="artist-disambiguation">{{ artist.disambiguation }}</div>
            {% endif %}
            <div class="artist-stats">
                {# Show local/total counts - "X/Y" means X verf端gbar, Y total #}
                <span title="{{ artist.local_albums }} von {{ artist.total_albums }} Alben verf端gbar">
                    {{ artist.local_albums }}/{{ artist.total_albums }} album{{ 's' if artist.total_albums != 1 else '' }}
                </span>
                <span title="{{ artist.local_tracks }} von {{ artist.total_tracks }} Tracks verf端gbar">
                    {{ artist.local_tracks }}/{{ artist.total_tracks }} track{{ 's' if artist.total_tracks != 1 else '' }}
                </span>
            </div>
        </a>
        {% endfor %}
    </div>
    
    {# No pagination - all artists shown on one page (2025-12) #}
    
    {% else %}
    <div class="empty-state">
        <div class="empty-icon empty-icon-animated">
            <i class="bi bi-people"></i>
        </div>
        <h3>No artists found</h3>
        <p>Your local library is empty. Scan your music folder to import existing files.</p>
        <a href="/library" class="btn btn-primary">
            <i class="bi bi-folder2-open"></i>
            Scan Music Folder
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<style>
    .artists-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: var(--space-4);
    }
    .artist-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        text-align: center;
        text-decoration: none;
        color: var(--text-primary);
        transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .artist-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }
    .artist-avatar {
        width: 80px;
        height: 80px;
        margin: 0 auto var(--space-4);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-bold);
        color: white;
        transition: transform var(--transition-fast);
        overflow: hidden;
    }
    .artist-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .artist-card:hover .artist-avatar {
        transform: scale(1.1);
    }
    .artist-name {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-bold);
        margin-bottom: var(--space-2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .artist-card:hover .artist-name {
        color: #a855f7;
    }
    .artist-disambiguation {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        opacity: 0.7;
        margin-bottom: var(--space-2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .artist-stats {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
        font-size: var(--font-size-sm);
        color: var(--text-muted);
    }
    .empty-state {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-xl);
        padding: var(--space-12);
        text-align: center;
    }
    .empty-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto var(--space-4);
        background: var(--bg-tertiary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-3xl);
        color: var(--text-muted);
    }
    .empty-state h3 {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
        margin-bottom: var(--space-2);
    }
    .empty-state p {
        color: var(--text-muted);
        margin-bottom: var(--space-6);
    }
    
    /* Enrichment Banner Styles */
    .enrichment-banner {
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(124, 58, 237, 0.1));
        border: 1px solid rgba(168, 85, 247, 0.3);
        border-radius: var(--radius-xl);
        padding: var(--space-4);
        margin-bottom: var(--space-6);
    }
    .enrichment-banner-content {
        display: flex;
        align-items: center;
        gap: var(--space-4);
    }
    .enrichment-banner-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-xl);
        color: white;
        flex-shrink: 0;
    }
    .enrichment-banner-text {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }
    .enrichment-banner-text strong {
        color: var(--text-primary);
    }
    .enrichment-banner-text span {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
    }
    .enrichment-progress {
        margin-top: var(--space-3);
        padding-top: var(--space-3);
        border-top: 1px solid rgba(168, 85, 247, 0.2);
    }
    .enrichment-progress-bar {
        height: 6px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-full);
        overflow: hidden;
    }
    .enrichment-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #a855f7, #7c3aed);
        width: 0%;
        transition: width 0.3s ease;
        animation: progressPulse 1.5s ease-in-out infinite;
    }
    @keyframes progressPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    .enrichment-progress-text {
        display: block;
        text-align: center;
        font-size: var(--font-size-sm);
        color: var(--text-muted);
        margin-top: var(--space-2);
    }
    .enrichment-banner.is-enriching .enrichment-banner-content {
        opacity: 0.6;
        pointer-events: none;
    }
    .enrichment-banner.is-complete {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(22, 163, 74, 0.1));
        border-color: rgba(34, 197, 94, 0.3);
    }
    .enrichment-banner.is-complete .enrichment-banner-icon {
        background: linear-gradient(135deg, #22c55e, #16a34a);
    }
</style>
<script>
// Hey future me - simple client-side search. Filters artist cards by name.
// Uses debounce to avoid too many DOM operations on fast typing.
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('artist-search');
    if (searchInput) {
        let debounceTimer;
        searchInput.addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase();
                const artistCards = document.querySelectorAll('.artist-card');
                
                artistCards.forEach(card => {
                    const artistName = card.querySelector('.artist-name').textContent.toLowerCase();
                    card.style.display = artistName.includes(searchTerm) ? '' : 'none';
                });
            }, 200);
        });
    }
});

// Enrichment polling - polls status after triggering enrichment
let enrichmentPollInterval = null;

function startEnrichmentPolling() {
    const banner = document.getElementById('enrichment-banner');
    const progress = document.getElementById('enrichment-progress');
    const btn = document.getElementById('enrich-btn');
    
    if (!banner) return;
    
    // Show progress, disable button
    banner.classList.add('is-enriching');
    progress.style.display = 'block';
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Enriching...';
    
    // Start polling for status
    enrichmentPollInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/enrichment/status');
            const data = await response.json();
            
            // Update progress text
            const progressText = progress.querySelector('.enrichment-progress-text');
            const progressFill = progress.querySelector('.enrichment-progress-fill');
            
            // Hey future me - check is_running, not just unenriched count!
            // Job might complete with some artists still unenriched (not found on Spotify)
            if (!data.is_running) {
                // Job finished (either completed or failed)
                clearInterval(enrichmentPollInterval);
                
                if (data.last_job_completed === true) {
                    // Success!
                    banner.classList.remove('is-enriching');
                    banner.classList.add('is-complete');
                    progressFill.style.width = '100%';
                    progressText.textContent = 'Complete! Refreshing...';
                } else if (data.last_job_completed === false) {
                    // Failed
                    banner.classList.remove('is-enriching');
                    banner.classList.add('is-error');
                    progressFill.style.width = '100%';
                    progressFill.style.backgroundColor = 'var(--color-error, #ef4444)';
                    progressText.textContent = 'Enrichment failed. Refreshing...';
                }
                
                // Reload page after short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                // Still in progress - show remaining count
                progressText.textContent = `${data.artists_unenriched} artists remaining...`;
                // Animate progress bar (indeterminate)
                progressFill.style.width = '60%';
            }
        } catch (err) {
            console.error('Enrichment status poll error:', err);
        }
    }, 2000); // Poll every 2 seconds
}
</script>
{% endblock %}
