{# Hey future me - Playlist detail page!
   Shows playlist header with cover, name, description, stats.
   Track list in a table with album art, status badges, actions.
   The download/sync actions use HTMX for async operations.
   Bulk selection logic is preserved - watch for checkbox state updates!
   hide_breadcrumbs = true weil wir eigene Breadcrumbs haben! #}

{% extends "base.html" %}

{% block title %}{{ playlist.name }} - SoulSpot{% endblock %}

{# Hey future me - Diese Seite hat eigene Breadcrumbs, also Topbar-Breadcrumbs ausblenden! #}
{% block hide_breadcrumbs %}true{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="breadcrumb" style="margin-bottom: var(--space-6);">
    <a href="/playlists" style="color: var(--accent-primary);">Playlists</a>
    <span style="color: var(--text-muted); margin: 0 var(--space-2);">/</span>
    <span style="color: var(--text-muted);">{{ playlist.name }}</span>
</nav>

<!-- Playlist Header -->
<div class="card" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); padding: var(--space-8); margin-bottom: var(--space-8);">
    <div class="flex gap-6" style="align-items: flex-start;">
        {# ImageService: local cache > placeholder (no CDN!)
           Playlists are synced to DB so images should be local #}
        <img src="{{ get_display_url(playlist.cover_url, playlist.cover_path, 'playlist', true) }}"
            alt="{{ playlist.name }}"
            style="width: 200px; height: 200px; border-radius: var(--radius-lg); object-fit: cover; box-shadow: var(--shadow-xl); flex-shrink: 0;">
        <div style="flex: 1; min-width: 0;">
            <div style="font-size: var(--font-size-xs); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: var(--space-2);">
                Playlist
            </div>
            <h1 style="font-size: var(--font-size-4xl); margin-bottom: var(--space-2);">{{ playlist.name }}</h1>
            {% if playlist.description %}
            <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">{{ playlist.description }}</p>
            {% endif %}
            <div class="flex gap-3" style="font-size: var(--font-size-sm); color: var(--text-muted); margin-bottom: var(--space-6); flex-wrap: wrap;">
                <span>{{ playlist.track_count|default(0) }} tracks</span>
                <span>•</span>
                <span>{{ playlist.tracks|selectattr('file_path')|list|length if playlist.tracks else 0 }} downloaded</span>
                {% if playlist.source %}
                <span>•</span>
                <span class="badge badge-info">{{ playlist.source }}</span>
                {% endif %}
            </div>
            <div class="flex gap-3" style="flex-wrap: wrap;">
                <button class="btn btn-primary btn-lg"
                        hx-post="/api/playlists/{{ playlist.id }}/sync"
                        hx-target="#sync-status"
                        hx-swap="innerHTML"
                        hx-indicator="#sync-spinner">
                    <i class="bi bi-arrow-clockwise"></i>
                    Sync Now
                </button>
                <button id="bulk-download-btn" class="btn btn-outline btn-lg" style="display: none;"
                        onclick="bulkDownloadSelected()">
                    <i class="bi bi-download"></i>
                    Download Selected (<span id="selected-count">0</span>)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sync Status -->
<div id="sync-status" style="margin-bottom: var(--space-6);"></div>
<span id="sync-spinner" class="htmx-indicator" style="display: none;">
    <i class="bi bi-arrow-repeat bi-spin"></i> Syncing...
</span>

<!-- Stats Grid -->
<div class="stats-grid" style="margin-bottom: var(--space-8);">
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(var(--accent-primary-rgb), 0.1); color: var(--accent-primary);">
            <i class="bi bi-music-note"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ playlist.track_count|default(0) }}</div>
            <div class="stat-label">Total Tracks</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
            <i class="bi bi-check"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" style="color: #22c55e;">{{ playlist.tracks|selectattr('file_path')|list|length if playlist.tracks else 0 }}</div>
            <div class="stat-label">Downloaded</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(234, 179, 8, 0.1); color: #eab308;">
            <i class="bi bi-clock"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" style="color: #eab308;">{{ playlist.tracks|rejectattr('file_path')|list|length if playlist.tracks else 0 }}</div>
            <div class="stat-label">Missing</div>
        </div>
    </div>
</div>

<!-- Track List -->
<div class="card" style="padding: 0; overflow: hidden;">
    <div style="padding: var(--space-4) var(--space-6); border-bottom: 1px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center;">
        <h2 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold);">Tracks</h2>
        <div class="flex gap-2">
            <button class="btn btn-outline btn-sm" onclick="toggleSelectAll()">
                <i class="bi bi-check-all"></i>
                Select All
            </button>
            <button class="btn btn-outline btn-sm"
                    hx-get="/playlists/{{ playlist.id }}/missing-tracks"
                    hx-target="#missing-tracks-section"
                    hx-swap="innerHTML">
                <i class="bi bi-list-check"></i>
                Missing Tracks
            </button>
        </div>
    </div>
    
    {% if playlist.tracks %}
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid var(--border-primary); background: var(--bg-tertiary);">
                    <th style="padding: var(--space-3) var(--space-4); text-align: left; width: 40px;">
                        <input type="checkbox" id="select-all-checkbox" onclick="toggleSelectAll()"
                               style="accent-color: var(--accent-primary);">
                    </th>
                    <th style="padding: var(--space-3); text-align: left; width: 50px; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">#</th>
                    <th style="padding: var(--space-3); text-align: left; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Title</th>
                    <th style="padding: var(--space-3); text-align: left; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Artist</th>
                    <th style="padding: var(--space-3); text-align: left; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Album</th>
                    <th style="padding: var(--space-3); text-align: left; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Duration</th>
                    <th style="padding: var(--space-3); text-align: left; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Status</th>
                    <th style="padding: var(--space-3) var(--space-4); text-align: right; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Actions</th>
                </tr>
            </thead>
            <tbody id="tracks-tbody">
                {% for track in playlist.tracks %}
                <tr class="track-row" data-track-id="{{ track.id }}" style="border-bottom: 1px solid var(--border-primary);">
                    <td style="padding: var(--space-3) var(--space-4);">
                        <input type="checkbox" class="track-checkbox"
                               data-track-id="{{ track.id }}"
                               data-status="{% if track.is_broken %}broken{% elif track.file_path %}downloaded{% else %}missing{% endif %}"
                               onchange="updateBulkActions()"
                               style="accent-color: var(--accent-primary);">
                    </td>
                    <td style="padding: var(--space-3); color: var(--text-muted);">{{ loop.index }}</td>
                    <td style="padding: var(--space-3);"> 
                        <div class="flex gap-3" style="align-items: center;">
                            {# ImageService: local cache > CDN > placeholder #}
                            <img src="{{ get_display_url(track.album_art, track.album_art_path, 'album') }}"
                                style="width: 40px; height: 40px; border-radius: var(--radius-sm); object-fit: cover; flex-shrink: 0;">
                            <span style="font-weight: var(--font-weight-medium);">{{ track.title or 'Unknown Title' }}</span>
                        </div>
                    </td>
                    <td style="padding: var(--space-3); color: var(--text-secondary);">{{ track.artist or 'Unknown Artist' }}</td>
                    <td style="padding: var(--space-3); color: var(--text-secondary);">{{ track.album or 'Unknown Album' }}</td>
                    <td style="padding: var(--space-3); color: var(--text-muted);">
                        {% if track.duration_ms %}
                            {% set minutes = (track.duration_ms / 60000)|int %}
                            {% set seconds = ((track.duration_ms % 60000) / 1000)|int %}
                            {{ "%d:%02d"|format(minutes, seconds) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td style="padding: var(--space-3);">
                        {% if track.is_broken %}
                        <span class="badge badge-error">
                            <i class="bi bi-exclamation-triangle"></i>
                            Broken
                        </span>
                        {% elif track.file_path %}
                        <span class="badge badge-success">
                            <i class="bi bi-check"></i>
                            Downloaded
                        </span>
                        {% else %}
                        <span class="badge badge-warning">
                            <i class="bi bi-clock"></i>
                            Missing
                        </span>
                        {% endif %}
                    </td>
                    <td style="padding: var(--space-3) var(--space-4); text-align: right;">
                        <div class="flex gap-2" style="justify-content: flex-end;">
                            {% if not track.file_path or track.is_broken %}
                            <button class="btn-icon" 
                                    hx-post="/api/downloads" 
                                    hx-vals='{"track_id": "{{ track.id }}"}'
                                    hx-swap="none" 
                                    hx-on::after-request="if(event.detail.successful) SoulSpot.toast('Download queued', 'success')"
                                    title="Download">
                                <i class="bi bi-download"></i>
                            </button>
                            {% endif %}
                            {% if track.spotify_uri %}
                            <a href="{{ track.spotify_uri }}" target="_blank" class="btn-icon" title="Open in Spotify" style="color: #1DB954;">
                                <i class="bi bi-spotify"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 4rem;">
        <i class="bi bi-music-note" style="font-size: 4rem; color: var(--text-muted); margin-bottom: 1.5rem; display: block;"></i>
        <h3 style="margin-bottom: var(--space-2);">No Tracks in Playlist</h3>
        <p style="color: var(--text-muted); margin-bottom: var(--space-6);">
            This playlist is empty. Sync with Spotify to add tracks.
        </p>
        <button class="btn btn-primary" hx-post="/api/playlists/{{ playlist.id }}/sync" hx-swap="none">
            <i class="bi bi-arrow-clockwise"></i>
            Sync Now
        </button>
    </div>
    {% endif %}
</div>

<!-- Missing Tracks Section -->
<div id="missing-tracks-section" style="margin-top: var(--space-6);"></div>
{% endblock %}

{% block extra_scripts %}
<style>
    .track-row {
        transition: background-color var(--transition-fast);
    }
    .track-row:hover {
        background-color: var(--bg-tertiary);
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
    }
    .stat-card {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        display: flex;
        align-items: center;
        gap: var(--space-4);
        border: 1px solid var(--border-primary);
    }
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-xl);
    }
    .stat-value {
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-bold);
    }
    .stat-label {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
    }
</style>
<script>
    // Hey future me - Bulk selection functionality
    // This handles the checkbox logic for selecting multiple tracks at once.
    // Watch out: the data-status attribute is used to filter already-downloaded tracks!
    
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const trackCheckboxes = document.querySelectorAll('.track-checkbox');
        const isChecked = selectAllCheckbox ? selectAllCheckbox.checked : 
                         document.querySelectorAll('.track-checkbox:checked').length === 0;
        
        trackCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = isChecked;
        }
        
        updateBulkActions();
    }

    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.track-checkbox:checked');
        const bulkDownloadBtn = document.getElementById('bulk-download-btn');
        const selectedCount = document.getElementById('selected-count');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const allCheckboxes = document.querySelectorAll('.track-checkbox');
        
        if (selectedCount) {
            selectedCount.textContent = checkedBoxes.length;
        }
        
        if (bulkDownloadBtn) {
            bulkDownloadBtn.style.display = checkedBoxes.length > 0 ? 'inline-flex' : 'none';
        }
        
        // Update select all checkbox state
        if (selectAllCheckbox && allCheckboxes.length > 0) {
            selectAllCheckbox.checked = checkedBoxes.length === allCheckboxes.length;
            selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
        }
    }

    // Hey future me - switched to /api/downloads for WAITING status support when slskd offline!
    function bulkDownloadSelected() {
        const checkedBoxes = document.querySelectorAll('.track-checkbox:checked');
        const trackIds = Array.from(checkedBoxes)
            .filter(cb => cb.getAttribute('data-status') !== 'downloaded')
            .map(cb => cb.getAttribute('data-track-id'));
        
        if (trackIds.length === 0) {
            SoulSpot.showNotification('All selected tracks are already downloaded', 'info');
            return;
        }
        
        if (confirm(`Download ${trackIds.length} track(s)?`)) {
            let completed = 0;
            let failed = 0;
            trackIds.forEach(trackId => {
                fetch('/api/downloads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ track_id: trackId })
                })
                .then(response => {
                    completed++;
                    if (!response.ok) failed++;
                    if (completed === trackIds.length && failed > 0) {
                        SoulSpot.showNotification(`Queued ${completed - failed}/${trackIds.length} (${failed} failed)`, 'warning');
                    }
                })
                .catch(error => {
                    completed++;
                    failed++;
                    console.error(`Error queuing download for track ${trackId}:`, error);
                });
            });
            
            SoulSpot.showNotification(`Queued ${trackIds.length} track(s) for download`, 'success');
            
            // Clear selections
            document.querySelectorAll('.track-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('select-all-checkbox').checked = false;
            updateBulkActions();
        }
    }

    // Hey future me - HTMX response handler for sync/download actions
    // The sync endpoint returns JSON, but we want a nice notification + HTML update
    // Watch out: hx-target="#sync-status" would show raw JSON, so we intercept here!
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        const target = evt.detail.elt;
        
        // Handle sync response - parse JSON and show nice notification
        if (target.matches('[hx-post*="sync"]')) {
            try {
                const response = JSON.parse(evt.detail.xhr.responseText);
                
                // Build nice notification message
                let message = `✓ ${response.playlist_name || 'Playlist'} synchronized`;
                if (response.total_tracks !== undefined) {
                    message += ` • ${response.total_tracks} tracks`;
                }
                if (response.tracks_failed > 0) {
                    message += ` • ${response.tracks_failed} failed`;
                    SoulSpot.showNotification(message, 'warning');
                } else {
                    SoulSpot.showNotification(message, 'success');
                }
                
                // Build HTML for sync-status instead of raw JSON
                const statusHtml = `
                    <div class="alert alert-success" style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-4); background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: var(--radius-lg);">
                        <i class="bi bi-check-circle" style="color: #22c55e; font-size: var(--font-size-xl);"></i>
                        <div>
                            <div style="font-weight: var(--font-weight-medium);">Sync erfolgreich</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-muted);">
                                ${response.total_tracks} Tracks synchronisiert${response.tracks_failed > 0 ? `, ${response.tracks_failed} fehlgeschlagen` : ''}
                            </div>
                        </div>
                        <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: var(--text-muted); cursor: pointer;">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                `;
                evt.detail.serverResponse = statusHtml;
                
                // Reload page after short delay to show updated tracks
                setTimeout(() => location.reload(), 1500);
                
            } catch (e) {
                // Fallback if JSON parsing fails
                SoulSpot.showNotification('Playlist sync completed', 'success');
            }
        }
    });
    
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.successful) {
            const target = evt.detail.elt;
            if (target.matches('[hx-post*="download"]')) {
                SoulSpot.showNotification('Added to download queue', 'success');
            }
            // Sync notification is now handled in htmx:beforeSwap
        }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateBulkActions();
    });
</script>
{% endblock %}
