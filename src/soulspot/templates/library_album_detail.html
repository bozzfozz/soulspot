{# Hey future me - Album detail page with stats, bulk actions, and track table.
   Shows album cover from Spotify CDN (artwork_url) or placeholder icon.
   artwork_url comes from album.artwork_url. Fallback to bi-disc icon if no artwork.
   Stats cards show total/verfügbar/missing/broken counts.
   Bulk selection like playlist_detail but scoped to album tracks.
   Download all missing button queues multiple API calls. #}

{% extends "base.html" %}

{% block title %}{{ album.title }} - Albums - SoulSpot{% endblock %}

{# Hey future me - Diese Seite hat eigene Breadcrumbs, also Topbar-Breadcrumbs ausblenden! #}
{% block hide_breadcrumbs %}true{% endblock %}

{% block content %}
<!-- Breadcrumb - hierarchical: Library → Artists → Artist → Album -->
<nav style="margin-bottom: var(--space-4);">
    <ol style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-size-sm); list-style: none; padding: 0; margin: 0;">
        <li><a href="/library" style="color: var(--accent-primary);">Library</a></li>
        <li style="color: var(--text-muted);"><i class="bi bi-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i></li>
        {% if album.is_compilation %}
        <li><a href="/library/compilations" style="color: var(--accent-primary);">Compilations</a></li>
        {% else %}
        <li><a href="/library/artists" style="color: var(--accent-primary);">Artists</a></li>
        <li style="color: var(--text-muted);"><i class="bi bi-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i></li>
        <li><a href="/library/artists/{{ album.artist_slug }}" style="color: var(--accent-primary);">{{ album.artist }}</a></li>
        {% endif %}
        <li style="color: var(--text-muted);"><i class="bi bi-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i>{{ album.title }}</li>
    </ol>
</nav>

<!-- Album Header -->
<div style="display: flex; flex-wrap: wrap; gap: var(--space-6); margin-bottom: var(--space-8);">
    <div class="album-cover-large">
        {# ImageService provides: local cache > CDN > placeholder #}
        <img src="{{ get_display_url(album.artwork_url, album.artwork_path, 'album') }}" alt="{{ album.title }}" loading="lazy">
    </div>
    <div style="flex: 1; min-width: 200px;">
        <h1 style="font-size: var(--font-size-3xl); margin-bottom: var(--space-2);">{{ album.title }}</h1>
        <a href="/library/artists/{{ album.artist_slug }}" style="color: var(--accent-primary); font-size: var(--font-size-lg); font-weight: var(--font-weight-medium);">{{ album.artist }}</a>
        <div style="display: flex; flex-wrap: wrap; gap: var(--space-4); margin-top: var(--space-3); color: var(--text-muted); font-size: var(--font-size-sm);">
            {% if album.year %}
            <span><i class="bi bi-calendar" style="margin-right: var(--space-2);"></i>{{ album.year }}</span>
            {% endif %}
            <span><i class="bi bi-music-note" style="margin-right: var(--space-2);"></i>{{ album.tracks|length }} track{{ 's' if album.tracks|length != 1 else '' }}</span>
            {% if album.total_duration_ms %}
                {% set total_minutes = (album.total_duration_ms / 60000) | int %}
            <span><i class="bi bi-clock" style="margin-right: var(--space-2);"></i>{{ total_minutes }} min</span>
            {% endif %}
        </div>
        {% if album.is_complete is defined %}
        <div style="margin-top: var(--space-3);">
            {% if album.is_complete %}
                <span class="badge badge-success">Complete</span>
            {% else %}
                <span class="badge badge-warning">Incomplete</span>
                <span style="color: var(--text-muted); margin-left: var(--space-2); font-size: var(--font-size-sm);">
                    {{ album.tracks|length }} of {{ album.expected_tracks }} tracks
                </span>
            {% endif %}
        </div>
        {% endif %}
        
        {# Compilation Badge & Detection Info #}
        {% if album.is_compilation %}
        <div style="margin-top: var(--space-3); display: flex; align-items: center; gap: var(--space-3);">
            <span class="badge" style="background: rgba(139, 92, 246, 0.2); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3);">
                <i class="bi bi-collection" style="margin-right: var(--space-1);"></i>
                Compilation
            </span>
            <button type="button" 
                    class="btn btn-sm btn-ghost"
                    onclick="showCompilationInfo()"
                    title="Why detected as compilation?">
                <i class="bi bi-info-circle"></i>
            </button>
            <button type="button"
                    class="btn btn-sm btn-ghost"
                    onclick="toggleCompilationStatus(false)"
                    title="Not a compilation? Click to remove">
                <i class="bi bi-x-circle"></i>
            </button>
        </div>
        {% else %}
        {# Show "Mark as compilation" option for non-compilations #}
        <div style="margin-top: var(--space-3);">
            <button type="button"
                    class="btn btn-sm btn-ghost"
                    onclick="toggleCompilationStatus(true)"
                    style="color: var(--text-muted);"
                    title="Mark as compilation">
                <i class="bi bi-collection"></i>
                Mark as Compilation
            </button>
        </div>
        {% endif %}
        
        {# Hey future me - External service links! MusicBrainz and Spotify.
           These open in new tabs so users can explore metadata sources.
           Also show disambiguation if available (Lidarr-style naming). #}
        {% if album.disambiguation %}
        <div style="margin-top: var(--space-2); font-size: var(--font-size-sm); color: var(--text-muted); opacity: 0.7;">
            <i class="bi bi-info-circle" style="margin-right: var(--space-1);"></i>{{ album.disambiguation }}
        </div>
        {% endif %}
        <div style="display: flex; gap: var(--space-3); flex-wrap: wrap; margin-top: var(--space-3);">
            {% if album.musicbrainz_id %}
            <a href="https://musicbrainz.org/release-group/{{ album.musicbrainz_id }}" 
               target="_blank" 
               rel="noopener noreferrer"
               class="external-link-badge musicbrainz"
               title="View on MusicBrainz">
                <i class="bi bi-box-arrow-up-right"></i> MusicBrainz
            </a>
            {% endif %}
            {% if album.spotify_uri %}
            <a href="https://open.spotify.com/album/{{ album.spotify_uri.replace('spotify:album:', '') }}" 
               target="_blank" 
               rel="noopener noreferrer"
               class="external-link-badge spotify"
               title="Open in Spotify">
                <i class="bi bi-spotify"></i> Spotify
            </a>
            {% endif %}
        </div>
    </div>
</div>

{# Compilation Detection Info Modal #}
<div id="compilation-info-modal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeCompilationInfo()"></div>
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3><i class="bi bi-collection" style="color: #a78bfa; margin-right: var(--space-2);"></i>Compilation Detection</h3>
            <button type="button" class="btn btn-ghost btn-sm" onclick="closeCompilationInfo()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body" id="compilation-info-content">
            <div class="loading-spinner">Loading detection info...</div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="verifyWithMusicBrainz()">
                <i class="bi bi-cloud-check"></i>
                Verify with MusicBrainz
            </button>
            <button type="button" class="btn btn-primary" onclick="closeCompilationInfo()">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Stats Cards -->
{% set available_count = album.tracks | selectattr("file_path") | list | length %}
{% set missing_count = album.tracks | rejectattr("file_path") | list | length %}
{% set broken_count = album.tracks | selectattr("is_broken") | list | length %}
<div class="stats-grid" style="margin-bottom: var(--space-6);">
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(var(--accent-primary-rgb), 0.1); color: var(--accent-primary);">
            <i class="bi bi-music-note"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ album.tracks|length }}</div>
            <div class="stat-label">Total Tracks</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
            <i class="bi bi-check"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" style="color: #22c55e;">{{ available_count }}</div>
            <div class="stat-label">Verfügbar</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(234, 179, 8, 0.1); color: #eab308;">
            <i class="bi bi-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" style="color: #eab308;">{{ missing_count }}</div>
            <div class="stat-label">Missing</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
            <i class="bi bi-x-circle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" style="color: #ef4444;">{{ broken_count }}</div>
            <div class="stat-label">Broken</div>
        </div>
    </div>
</div>

<!-- Tracks Section -->
<div class="card" style="padding: 0; overflow: hidden;">
    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: var(--space-4); padding: var(--space-4) var(--space-5); border-bottom: 1px solid var(--border-primary);">
        <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold);">Tracks</h2>
        <div style="display: flex; flex-wrap: wrap; gap: var(--space-3);">
            <input type="text" 
                   id="track-search"
                   placeholder="Search tracks..."
                   class="form-input"
                   style="min-width: 160px;">
            {% if missing_count > 0 or broken_count > 0 %}
            <button id="download-all-missing-btn" 
                    class="btn btn-primary"
                    onclick="downloadAllMissing()">
                <i class="bi bi-download"></i>
                Download All Missing ({{ missing_count + broken_count }})
            </button>
            {% endif %}
            <button id="bulk-download-btn" 
                    class="btn btn-outline hidden"
                    onclick="bulkDownloadSelected()">
                <i class="bi bi-download"></i>
                Download Selected (<span id="selected-count">0</span>)
            </button>
        </div>
    </div>
    
    {# Hey future me - STREAMING-ONLY BANNER!
       Shows when album has no local files, tracks are from Deezer/Spotify API.
       User can then download individual tracks or the whole album. #}
    {% if album.is_streaming_only %}
    <div class="streaming-only-banner" style="margin-bottom: var(--space-4); padding: var(--space-4); background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: var(--radius-lg); display: flex; align-items: center; gap: var(--space-3);">
        <i class="bi bi-cloud" style="font-size: 1.5rem; color: var(--accent-primary);"></i>
        <div>
            <div style="font-weight: var(--font-weight-semibold); color: var(--text-primary);">
                Streaming-Only Album
            </div>
            <div style="font-size: var(--font-size-sm); color: var(--text-muted);">
                Diese Tracks sind nicht lokal vorhanden. Tracklist von 
                {% if album.streaming_provider == 'deezer' %}Deezer{% elif album.streaming_provider == 'spotify' %}Spotify{% else %}Provider{% endif %} 
                geladen. Klicke auf "Download" um Tracks herunterzuladen.
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if album.tracks %}
    <div style="overflow-x: auto;">
        <table class="data-table" style="min-width: 100%;">
            <thead>
                <tr>
                    <th style="width: 48px; text-align: center;">
                        <input type="checkbox" 
                               id="select-all-checkbox"
                               class="form-checkbox"
                               onclick="toggleSelectAll()">
                    </th>
                    <th style="width: 60px; text-align: center;">#</th>
                    <th style="text-align: left;">Title</th>
                    <th style="width: 100px; text-align: center;">Duration</th>
                    <th style="width: 120px; text-align: center;">Status</th>
                    <th style="width: 150px; text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody id="tracks-tbody">
                {# Hey future me - Multi-disc handling! For compilations and box sets,
                   we show disc separators when disc_number changes. Same logic as
                   spotify_album_detail.html. Tracks are already sorted by disc/track. #}
                {% set current_disc = namespace(value=0) %}
                {% set is_multi_disc = album.tracks|map(attribute='disc_number')|unique|list|length > 1 %}
                {% for track in album.tracks %}
                {# Insert disc separator row when disc changes (only for multi-disc albums) #}
                {% if is_multi_disc and track.disc_number != current_disc.value %}
                {% set current_disc.value = track.disc_number %}
                <tr class="disc-separator-row">
                    <td colspan="6">
                        <div class="disc-separator">
                            <i class="bi bi-disc"></i>
                            <span>CD {{ track.disc_number }}</span>
                        </div>
                    </td>
                </tr>
                {% endif %}
                <tr class="track-row" 
                    data-track-id="{{ track.id }}"
                    data-spotify-id="{{ track.spotify_id or '' }}"
                    data-deezer-id="{{ track.deezer_id or '' }}"
                    data-tidal-id="{{ track.tidal_id or '' }}"
                    data-source="{{ track.source }}"
                    data-title="{{ track.title|lower }}"
                    data-artist="{{ track.artist }}"
                    data-album="{{ album.title }}">
                    <td style="text-align: center;">
                        <input type="checkbox" 
                               class="track-checkbox form-checkbox"
                               data-track-id="{{ track.id }}"
                               data-spotify-id="{{ track.spotify_id or '' }}"
                               data-deezer-id="{{ track.deezer_id or '' }}"
                               data-tidal-id="{{ track.tidal_id or '' }}"
                               data-source="{{ track.source }}"
                               data-track-title="{{ track.title }}"
                               data-track-artist="{{ track.artist }}"
                               data-status="{% if track.is_broken %}broken{% elif track.is_downloaded %}available{% else %}missing{% endif %}"
                               onchange="updateBulkActions()">
                    </td>
                    <td style="text-align: center; color: var(--text-muted);">{{ track.track_number or loop.index }}</td>
                    <td style="text-align: left;"><span style="font-weight: var(--font-weight-medium);">{{ track.title }}</span></td>
                    <td style="text-align: center; color: var(--text-muted);">
                        {% if track.duration_ms %}
                            {% set minutes = (track.duration_ms / 60000) | int %}
                            {% set seconds = ((track.duration_ms % 60000) / 1000) | int %}
                            {{ "%d:%02d" | format(minutes, seconds) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% if track.is_broken %}
                            <span class="badge badge-error">Broken</span>
                        {% elif track.file_path %}
                            <span class="badge badge-success">Verfügbar</span>
                        {% else %}
                            <span class="badge badge-warning">Missing</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        <div style="display: flex; justify-content: center; gap: var(--space-2);">
                            {% if not track.is_downloaded %}
                            {# Multi-provider download support: Spotify, Deezer, Tidal #}
                            {% if track.spotify_id %}
                            {# Spotify track - construct spotify URI for download #}
                            <button class="btn btn-sm btn-outline"
                                    hx-post="/api/downloads"
                                    hx-vals='{"spotify_id": "spotify:track:{{ track.spotify_id }}", "title": "{{ track.title }}", "artist": "{{ track.artist }}", "album": "{{ album.title }}"}'
                                    hx-swap="none"
                                    hx-on::after-request="if(event.detail.successful) SoulSpot.toast('Download queued', 'success')">
                                <i class="bi bi-download"></i>
                                Download
                            </button>
                            {% elif track.deezer_id %}
                            {# Deezer track - use deezer_id for download #}
                            <button class="btn btn-sm btn-outline"
                                    hx-post="/api/downloads"
                                    hx-vals='{"deezer_id": "{{ track.deezer_id }}", "title": "{{ track.title }}", "artist": "{{ track.artist }}", "album": "{{ album.title }}"}'
                                    hx-swap="none"
                                    hx-on::after-request="if(event.detail.successful) SoulSpot.toast('Download queued', 'success')">
                                <i class="bi bi-download"></i>
                                Download
                            </button>
                            {% elif track.tidal_id %}
                            {# Tidal track - use tidal_id for download #}
                            <button class="btn btn-sm btn-outline"
                                    hx-post="/api/downloads"
                                    hx-vals='{"tidal_id": "{{ track.tidal_id }}", "title": "{{ track.title }}", "artist": "{{ track.artist }}", "album": "{{ album.title }}"}'
                                    hx-swap="none"
                                    hx-on::after-request="if(event.detail.successful) SoulSpot.toast('Download queued', 'success')">
                                <i class="bi bi-download"></i>
                                Download
                            </button>
                            {% else %}
                            {# Local track missing file - use track_id #}
                            <button class="btn btn-sm btn-outline"
                                    hx-post="/api/downloads"
                                    hx-vals='{"track_id": "{{ track.id }}"}'
                                    hx-swap="none"
                                    hx-on::after-request="if(event.detail.successful) SoulSpot.toast('Download queued', 'success')">
                                <i class="bi bi-download"></i>
                                Download
                            </button>
                            {% endif %}
                            {% else %}
                            {# Track already downloaded #}
                            <button class="btn btn-sm btn-success" disabled>
                                <i class="bi bi-check"></i>
                                Downloaded
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-ghost"
                                    hx-get="/tracks/{{ track.id }}/metadata-editor"
                                    hx-target="#metadata-modal"
                                    hx-swap="innerHTML">
                                Edit
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    {# No tracks - show sync prompt if album needs sync, otherwise show generic empty state #}
    {% if album.needs_sync %}
    <div class="empty-state" style="padding: var(--space-12);">
        <div style="max-width: 500px; margin: 0 auto; text-align: center;">
            <i class="bi bi-cloud-download" style="font-size: 4rem; color: var(--text-muted); margin-bottom: var(--space-4);"></i>
            <h3 style="margin-bottom: var(--space-2);">Tracks Not Synced Yet</h3>
            <p style="color: var(--text-muted); margin-bottom: var(--space-4);">
                This album is in your library but track metadata hasn't been synced from 
                {% if album.source == 'spotify' %}Spotify{% elif album.source == 'deezer' %}Deezer{% else %}the provider{% endif %}.
            </p>
            {% if album.source == 'spotify' and album.spotify_uri %}
            <button class="btn btn-primary"
                    hx-post="/api/spotify/sync/album-tracks"
                    hx-vals='{"album_id": "{{ album.spotify_uri.split(':')[-1] }}"}'
                    hx-swap="none"
                    hx-on::after-request="if(event.detail.successful) { SoulSpot.toast('Album sync started', 'success'); setTimeout(() => location.reload(), 2000); }">
                <i class="bi bi-cloud-download"></i>
                Sync Tracks from Spotify
            </button>
            {% elif album.source == 'deezer' %}
            <button class="btn btn-primary"
                    onclick="SoulSpot.toast('Deezer album sync not yet implemented', 'warning')">
                <i class="bi bi-cloud-download"></i>
                Sync Tracks from Deezer
            </button>
            {% else %}
            <p style="color: var(--text-warning);">
                <i class="bi bi-exclamation-triangle"></i>
                Unknown source - cannot auto-sync. Check your sync settings.
            </p>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="empty-state" style="padding: var(--space-12);">
        <div class="empty-icon">
            <i class="bi bi-music-note"></i>
        </div>
        <h3>No tracks found</h3>
        <p>This album does not have any tracks in your library.</p>
    </div>
    {% endif %}
    {% endif %}
</div>

<!-- Metadata Modal Container -->
<div id="metadata-modal"></div>
{% endblock %}

{% block extra_scripts %}
<style>
    /* Disc separator for multi-disc albums (CD 1, CD 2, etc.) */
    .disc-separator-row td {
        padding: 0 !important;
        border-bottom: none !important;
    }
    .disc-separator {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-3) var(--space-4);
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-primary);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        color: #22c55e;
    }
    .disc-separator i {
        font-size: 1.1em;
    }
    
    .album-cover-large {
        width: 180px;
        height: 180px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border-radius: var(--radius-xl);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 5rem;
        color: rgba(255, 255, 255, 0.4);
        flex-shrink: 0;
        box-shadow: var(--shadow-xl);
        overflow: hidden;
    }
    .album-cover-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
    }
    .stat-card {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        border: 1px solid var(--border-primary);
    }
    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-lg);
    }
    .stat-value {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
    }
    .stat-label {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
    }
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    .data-table th {
        padding: var(--space-3) var(--space-4);
        text-align: left;
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: var(--bg-tertiary);
    }
    .data-table td {
        padding: var(--space-3) var(--space-4);
        border-bottom: 1px solid var(--border-primary);
        font-size: var(--font-size-sm);
    }
    .data-table tr:hover {
        background: var(--bg-hover);
    }
    .form-checkbox {
        width: 16px;
        height: 16px;
        border-radius: var(--radius-sm);
        border: 2px solid var(--border-secondary);
        background: transparent;
        cursor: pointer;
    }
    .form-checkbox:checked {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
    }
    .empty-state {
        text-align: center;
    }
    .empty-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto var(--space-4);
        background: var(--bg-tertiary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-2xl);
        color: var(--text-muted);
    }
    .empty-state h3 {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
        margin-bottom: var(--space-2);
    }
    .empty-state p {
        color: var(--text-muted);
    }
    .hidden {
        display: none !important;
    }
    /* Hey future me - External service link badges!
       MusicBrainz = yellow/orange (their brand color)
       Spotify = green (their brand color) */
    .external-link-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        text-decoration: none;
        transition: all var(--transition-fast);
    }
    .external-link-badge.musicbrainz {
        background: rgba(186, 83, 45, 0.15);
        color: #e69d3c;
        border: 1px solid rgba(186, 83, 45, 0.3);
    }
    .external-link-badge.musicbrainz:hover {
        background: rgba(186, 83, 45, 0.25);
        transform: translateY(-1px);
    }
    .external-link-badge.spotify {
        background: rgba(30, 215, 96, 0.15);
        color: #1ed760;
        border: 1px solid rgba(30, 215, 96, 0.3);
    }
    .external-link-badge.spotify:hover {
        background: rgba(30, 215, 96, 0.25);
        transform: translateY(-1px);
    }
</style>
<script>
// Hey future me - handles bulk selection, download all missing, and search filter for album tracks.
// Pattern from playlist_detail but simplified for album context.

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const trackCheckboxes = document.querySelectorAll('.track-checkbox');
    const isChecked = selectAllCheckbox ? selectAllCheckbox.checked : 
                     document.querySelectorAll('.track-checkbox:checked').length === 0;
    
    trackCheckboxes.forEach(checkbox => {
        const row = checkbox.closest('.track-row');
        if (row && row.style.display !== 'none') {
            checkbox.checked = isChecked;
        }
    });
    
    if (selectAllCheckbox) selectAllCheckbox.checked = isChecked;
    updateBulkActions();
}

function updateBulkActions() {
    const checkedBoxes = document.querySelectorAll('.track-checkbox:checked');
    const bulkDownloadBtn = document.getElementById('bulk-download-btn');
    const selectedCount = document.getElementById('selected-count');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const visibleCheckboxes = Array.from(document.querySelectorAll('.track-checkbox')).filter(cb => {
        const row = cb.closest('.track-row');
        return row && row.style.display !== 'none';
    });
    
    const downloadableSelected = Array.from(checkedBoxes).filter(cb => 
        cb.getAttribute('data-status') !== 'available'
    ).length;
    
    if (selectedCount) selectedCount.textContent = downloadableSelected;
    
    if (bulkDownloadBtn) {
        bulkDownloadBtn.classList.toggle('hidden', downloadableSelected === 0);
    }
    
    if (selectAllCheckbox && visibleCheckboxes.length > 0) {
        const visibleChecked = visibleCheckboxes.filter(cb => cb.checked).length;
        selectAllCheckbox.checked = visibleChecked === visibleCheckboxes.length;
        selectAllCheckbox.indeterminate = visibleChecked > 0 && visibleChecked < visibleCheckboxes.length;
    }
}

function bulkDownloadSelected() {
    const checkedBoxes = document.querySelectorAll('.track-checkbox:checked');
    const downloadableBoxes = Array.from(checkedBoxes).filter(cb => 
        cb.getAttribute('data-status') !== 'available'
    );
    
    if (downloadableBoxes.length === 0) {
        SoulSpot.showNotification('No tracks to download', 'info');
        return;
    }
    
    queueDownloadsFromCheckboxes(downloadableBoxes, `Queued ${downloadableBoxes.length} track(s) for download`);
    
    document.querySelectorAll('.track-checkbox').forEach(cb => cb.checked = false);
    if (document.getElementById('select-all-checkbox')) {
        document.getElementById('select-all-checkbox').checked = false;
    }
    updateBulkActions();
}

function downloadAllMissing() {
    const missingTracks = document.querySelectorAll('.track-checkbox[data-status="missing"], .track-checkbox[data-status="broken"]');
    
    if (missingTracks.length === 0) {
        SoulSpot.showNotification('Alle Tracks sind bereits verfügbar!', 'info');
        return;
    }
    
    queueDownloadsFromCheckboxes(Array.from(missingTracks), `Queued all ${missingTracks.length} missing track(s) for download`);
}

// Hey future me - Multi-provider download support (Spotify, Deezer, Tidal)!
// Reads data attributes from checkboxes to determine which API parameters to use.
// Priority: spotify_id > deezer_id > tidal_id > track_id (fallback).
function queueDownloadsFromCheckboxes(checkboxes, successMessage) {
    let successCount = 0;
    let failureCount = 0;
    
    const downloadPromises = checkboxes.map(checkbox => {
        const spotifyId = checkbox.getAttribute('data-spotify-id');
        const deezerId = checkbox.getAttribute('data-deezer-id');
        const tidalId = checkbox.getAttribute('data-tidal-id');
        const trackId = checkbox.getAttribute('data-track-id');
        const title = checkbox.getAttribute('data-track-title');
        const artist = checkbox.getAttribute('data-track-artist');
        const source = checkbox.getAttribute('data-source');
        
        // Determine which provider ID to use based on track source
        let requestBody;
        if (spotifyId) {
            // Spotify track - construct full URI
            requestBody = { 
                spotify_id: `spotify:track:${spotifyId}`,
                title: title,
                artist: artist,
                album: '{{ album.title }}'
            };
        } else if (deezerId) {
            // Deezer track
            requestBody = { 
                deezer_id: deezerId,
                title: title,
                artist: artist,
                album: '{{ album.title }}'
            };
        } else if (tidalId) {
            // Tidal track
            requestBody = { 
                tidal_id: tidalId,
                title: title,
                artist: artist,
                album: '{{ album.title }}'
            };
        } else {
            // Local track or no provider ID
            requestBody = { track_id: trackId };
        }
        
        return fetch('/api/downloads', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        })
        .then(response => {
            if (!response.ok) {
                failureCount++;
                return { success: false };
            }
            successCount++;
            return { success: true };
        })
        .catch(error => {
            failureCount++;
            console.error(`Error queuing download:`, error);
            return { success: false };
        });
    });
    
    Promise.all(downloadPromises).then(() => {
        if (failureCount === 0) {
            SoulSpot.showNotification(successMessage, 'success');
        } else if (successCount === 0) {
            SoulSpot.showNotification(`Failed to queue ${failureCount} track(s). Please try again.`, 'error');
        } else {
            SoulSpot.showNotification(`Queued ${successCount} track(s), ${failureCount} failed`, 'warning');
        }
    });
}

// DEPRECATED: Old function that only supported track_id
// Kept for reference, but replaced by queueDownloadsFromCheckboxes()
function queueDownloads(trackIds, successMessage) {
    let successCount = 0;
    let failureCount = 0;
    
    const downloadPromises = trackIds.map(trackId => 
        fetch('/api/downloads', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ track_id: trackId })
        })
        .then(response => {
            if (!response.ok) {
                failureCount++;
                return { success: false, trackId };
            }
            successCount++;
            return { success: true, trackId };
        })
        .catch(error => {
            failureCount++;
            console.error(`Error queuing download for track ${trackId}:`, error);
            return { success: false, trackId };
        })
    );
    
    Promise.all(downloadPromises).then(() => {
        if (failureCount === 0) {
            SoulSpot.showNotification(successMessage, 'success');
        } else if (successCount === 0) {
            SoulSpot.showNotification(`Failed to queue ${failureCount} track(s). Please try again.`, 'error');
        } else {
            SoulSpot.showNotification(`Queued ${successCount} track(s), ${failureCount} failed`, 'warning');
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('track-search');
    
    if (searchInput) {
        let debounceTimer;
        searchInput.addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const trackRows = document.querySelectorAll('.track-row');
                
                trackRows.forEach(row => {
                    const title = row.getAttribute('data-title') || '';
                    row.style.display = (title.includes(searchTerm) || searchTerm === '') ? '' : 'none';
                });
                
                updateBulkActions();
            }, 200);
        });
    }
    
    updateBulkActions();
});

// =============================================================================
// Compilation Detection Features
// =============================================================================

const ALBUM_ID = '{{ album.id }}';

function showCompilationInfo() {
    const modal = document.getElementById('compilation-info-modal');
    const content = document.getElementById('compilation-info-content');
    
    modal.style.display = 'flex';
    content.innerHTML = '<div class="loading-spinner">Loading detection info...</div>';
    
    fetch(`/api/library/compilations/${ALBUM_ID}/detection-info`)
        .then(response => response.json())
        .then(data => {
            content.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="badge ${data.is_compilation ? 'badge-purple' : 'badge-secondary'}">
                            ${data.is_compilation ? 'Compilation' : 'Not a Compilation'}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Detection Method:</span>
                        <span class="info-value">${formatDetectionReason(data.detection_reason)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Confidence:</span>
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <div class="progress-bar" style="width: 100px; height: 8px;">
                                <div class="progress-fill" style="width: ${data.confidence * 100}%; background: ${getConfidenceColor(data.confidence)};"></div>
                            </div>
                            <span>${Math.round(data.confidence * 100)}%</span>
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Track Diversity:</span>
                        <span class="info-value">${data.unique_artists} unique artist(s) / ${data.track_count} tracks 
                            (${Math.round(data.diversity_ratio * 100)}%)
                        </span>
                    </div>
                    <div style="margin-top: var(--space-4); padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md); font-size: var(--font-size-sm);">
                        <i class="bi bi-info-circle" style="margin-right: var(--space-2); color: var(--accent-primary);"></i>
                        ${data.explanation}
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error loading compilation info:', error);
            content.innerHTML = `
                <div class="alert alert-error">
                    <i class="bi bi-exclamation-triangle"></i>
                    Failed to load detection info. Please try again.
                </div>
            `;
        });
}

function closeCompilationInfo() {
    document.getElementById('compilation-info-modal').style.display = 'none';
}

function formatDetectionReason(reason) {
    const reasons = {
        'explicit_flag': '<i class="bi bi-tag"></i> Explicit Tag (TCMP/cpil)',
        'album_artist_pattern': '<i class="bi bi-person-badge"></i> Album Artist Pattern',
        'track_diversity': '<i class="bi bi-people"></i> Track Artist Diversity',
        'no_dominant_artist': '<i class="bi bi-diagram-3"></i> No Dominant Artist',
        'borderline_diversity': '<i class="bi bi-question-circle"></i> Borderline (Uncertain)',
        'no_indicators': '<i class="bi bi-dash-circle"></i> No Compilation Indicators',
        'mb_various_artists': '<i class="bi bi-cloud-check"></i> MusicBrainz: Various Artists',
        'mb_compilation_type': '<i class="bi bi-cloud-check"></i> MusicBrainz: Compilation Type',
        'mb_not_compilation': '<i class="bi bi-cloud-check"></i> MusicBrainz: Not Compilation',
        'manual_override': '<i class="bi bi-person-check"></i> Manual Override',
    };
    return reasons[reason] || reason;
}

function getConfidenceColor(confidence) {
    if (confidence >= 0.9) return '#22c55e';
    if (confidence >= 0.7) return '#eab308';
    return '#ef4444';
}

async function toggleCompilationStatus(setAsCompilation) {
    const action = setAsCompilation ? 'mark as compilation' : 'remove compilation status';
    
    if (!confirm(`Are you sure you want to ${action}?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/library/compilations/set-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                album_id: ALBUM_ID,
                is_compilation: setAsCompilation,
                reason: 'manual_override'
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update compilation status');
        }
        
        SoulSpot.showNotification(
            setAsCompilation ? 'Marked as compilation' : 'Removed compilation status',
            'success'
        );
        
        // Reload page to reflect changes
        setTimeout(() => location.reload(), 1000);
        
    } catch (error) {
        console.error('Error updating compilation status:', error);
        SoulSpot.showNotification('Failed to update status. Please try again.', 'error');
    }
}

async function verifyWithMusicBrainz() {
    const content = document.getElementById('compilation-info-content');
    content.innerHTML = `
        <div style="text-align: center; padding: var(--space-6);">
            <div class="loading-spinner"></div>
            <p style="margin-top: var(--space-4); color: var(--text-muted);">
                Querying MusicBrainz...<br>
                <small>(This may take a few seconds due to rate limits)</small>
            </p>
        </div>
    `;
    
    try {
        const response = await fetch('/api/library/compilations/verify-musicbrainz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                album_id: ALBUM_ID,
                update_if_confirmed: true
            })
        });
        
        const data = await response.json();
        
        let resultHtml = `
            <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                <div class="info-row">
                    <span class="info-label">MusicBrainz Result:</span>
                    <span class="badge ${data.is_compilation ? 'badge-purple' : 'badge-secondary'}">
                        ${data.is_compilation ? 'Compilation' : 'Not a Compilation'}
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Reason:</span>
                    <span class="info-value">${formatDetectionReason(data.reason)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Confidence:</span>
                    <span class="info-value">${Math.round(data.confidence * 100)}%</span>
                </div>
        `;
        
        if (data.mbid) {
            resultHtml += `
                <div class="info-row">
                    <span class="info-label">MusicBrainz ID:</span>
                    <a href="https://musicbrainz.org/release-group/${data.mbid}" 
                       target="_blank" 
                       style="color: var(--accent-primary);">
                        ${data.mbid.substring(0, 8)}...
                        <i class="bi bi-box-arrow-up-right" style="font-size: 0.8em;"></i>
                    </a>
                </div>
            `;
        }
        
        if (data.updated) {
            resultHtml += `
                <div class="alert alert-success" style="margin-top: var(--space-4);">
                    <i class="bi bi-check-circle"></i>
                    Album status updated based on MusicBrainz data.
                </div>
            `;
        }
        
        resultHtml += '</div>';
        content.innerHTML = resultHtml;
        
        if (data.updated) {
            setTimeout(() => location.reload(), 2000);
        }
        
    } catch (error) {
        console.error('Error verifying with MusicBrainz:', error);
        content.innerHTML = `
            <div class="alert alert-error">
                <i class="bi bi-exclamation-triangle"></i>
                Failed to verify with MusicBrainz. Please try again later.
            </div>
        `;
    }
}
</script>
{% endblock %}
