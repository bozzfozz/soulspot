# CSS Build Process in Docker

## Overview

The Dockerfile now includes a dedicated CSS builder stage that compiles Tailwind CSS from `input.css` to `style.css` during the Docker build process. This ensures that:

1. **CSS is always up-to-date** - Any changes to `input.css` are reflected in the built Docker image
2. **Build consistency** - The CSS build happens in the same environment for all builds
3. **No manual steps** - Developers don't need to manually run `npm run build:css` before Docker builds
4. **Branch support** - When building from a specific Git branch via `GIT_BRANCH` arg, CSS is rebuilt from that branch's `input.css`

## Architecture

### Multi-Stage Build

The Dockerfile uses a three-stage build process:

```
1. css-builder (Node.js stage)
   ├─ Install npm dependencies (tailwindcss)
   ├─ Build CSS from local files (or cloned branch if GIT_BRANCH is set)
   └─ Output: /build/src/soulspot/static/css/style.css

2. builder (Python stage)
   ├─ Copy source files
   ├─ Copy pre-built style.css from css-builder
   ├─ Handle GIT_BRANCH cloning (if needed)
   ├─ Build Python package with Poetry
   └─ Output: Wheel file with all dependencies

3. production (Python stage)
   ├─ Install runtime dependencies
   ├─ Copy Python packages from builder
   ├─ Copy built CSS (already in ./src/soulspot/static/css/style.css)
   ├─ Setup user/volumes
   └─ Start application
```

## Build Process

### Standard Build (Local Files)

```bash
docker build -t soulspot:latest .
```

**Steps:**
1. `css-builder` stage:
   - Installs npm dependencies
   - Copies `src/soulspot/static/css/input.css` from local context
   - Runs `npm run build:css` to generate `style.css`

2. `builder` stage:
   - Copies local source files (`pyproject.toml`, `src/`, `alembic/`, etc.)
   - Copies pre-built `style.css` from `css-builder` stage
   - Builds Python package
   - Creates wheel file

3. `production` stage:
   - Copies everything from `builder`
   - Application starts with built CSS ready

### Build from Git Branch

```bash
docker build --build-arg GIT_BRANCH=develop -t soulspot:develop .
```

**Steps:**
1. `css-builder` stage:
   - Installs npm dependencies
   - Builds CSS from local files first (for Docker build context)
   - If `GIT_BRANCH` is set:
     - Clones the specified branch from GitHub
     - Copies `input.css` from cloned repo
     - **Rebuilds CSS** with the branch's `input.css`
   - Output: `style.css` from the specified branch

2. `builder` stage:
   - Copies local source files (initial context)
   - Copies pre-built `style.css` from `css-builder`
   - Clones the branch again from GitHub (overwrites local files)
   - Builds Python package from cloned sources
   - **CSS is preserved** from css-builder stage (not overwritten by cloned files)

3. `production` stage:
   - Copies everything from `builder`
   - Application has CSS built from the specified branch

## CSS Build Details

### CSS Input File

**Location:** `src/soulspot/static/css/input.css`

This file contains:
- Tailwind CSS directives (@tailwind, @layer)
- Custom animations (@keyframes)
- Magic UI animations
- Component definitions
- Custom utilities

### npm Install in Docker

**Note:** The Dockerfile uses `npm install` instead of `npm ci` because:
- `npm ci` requires `package-lock.json` (strict reproducibility)
- `npm install` works with or without lockfile (flexibility)
- `npm install` will generate `package-lock.json` if missing
- For production builds, commit `package-lock.json` for best results

**Command in Dockerfile:**
```dockerfile
RUN npm install --prefer-offline --no-audit
```

**Recommendation:** Generate and commit `package-lock.json` once:
```bash
npm install
git add package-lock.json
git commit -m "Add package-lock.json for reproducible builds"
```

### CSS Output File

**Location:** `src/soulspot/static/css/style.css`

Generated by Tailwind CLI with:
- `--minify` flag (production-optimized)
- Purged unused styles
- ~50KB minified (includes all animations)

**Command:** `npm run build:css`

Defined in `package.json`:
```json
{
  "scripts": {
    "build:css": "tailwindcss -i ./src/soulspot/static/css/input.css -o ./src/soulspot/static/css/style.css --minify"
  }
}
```

## Development Workflow

### Local Development

1. **First-time setup (one time only):**
   ```bash
   # Install dependencies and generate package-lock.json
   npm install
   git add package-lock.json
   git commit -m "Add package-lock.json for reproducible builds"
   ```

2. **Edit CSS:**
   ```bash
   # Edit src/soulspot/static/css/input.css
   nano src/soulspot/static/css/input.css
   ```

3. **Watch for changes (optional):**
   ```bash
   npm run watch:css
   ```
   This automatically rebuilds `style.css` as you edit `input.css`

4. **Manual build:**
   ```bash
   npm run build:css
   ```

5. **Commit changes:**
   ```bash
   git add src/soulspot/static/css/input.css
   git add src/soulspot/static/css/style.css
   git commit -m "Update CSS animations"
   ```

### Docker Build

The CSS is automatically built during Docker build, so developers don't need to manually run `npm run build:css` before committing.

**However, it's still good practice to:**
1. Build locally: `npm run build:css`
2. Test locally: `make docker-up`
3. Verify CSS in browser
4. Commit both `input.css` and `style.css`

### Setup Notes

**Important:** First-time setup requires `package-lock.json`:
```bash
# Generate package-lock.json (one-time setup)
npm install

# Commit it to git
git add package-lock.json
git commit -m "Add package-lock.json for reproducible builds"
```

This lockfile ensures reproducible builds in Docker and CI/CD. It should be committed to git.

### Troubleshooting

### CSS Changes Not Appearing in Docker Container

**Problem:** You edited `input.css` but the container shows old styles.

**Solution:**
1. Ensure `style.css` is built locally:
   ```bash
   npm run build:css
   ```

2. Rebuild the Docker image (don't use cache):
   ```bash
   docker build --no-cache -t soulspot:latest .
   ```

3. If using docker-compose:
   ```bash
   make docker-up --force-recreate
   ```

### Docker Build Fails at CSS Compilation

**Problem:** "Command not found: tailwindcss" during docker build

**Solution:**
1. Verify `package.json` exists in project root
2. Verify `package-lock.json` or `yarn.lock` exists (for reproducible builds)
3. Check `npm run build:css` works locally:
   ```bash
   npm ci
   npm run build:css
   ```

### CSS File Size Issues

**Problem:** `style.css` is too large (>100KB)

**Solution:**
1. The CSS should be minified (~50KB)
2. Verify the `--minify` flag is in `package.json` build script
3. Check if unused styles are being purged correctly
4. Review `tailwind.config.js` for proper content paths

## Git Considerations

**Both files should be committed:**

```bash
git add src/soulspot/static/css/input.css
git add src/soulspot/static/css/style.css
```

**Why both?**
- `input.css` = Source of truth for CSS development
- `style.css` = Pre-built for production and quick local testing
- Allows quick feedback without rebuilding

**When to rebuild:**
- After editing `input.css`
- Before pushing to production
- Before creating Docker images for deployment

## Performance Impact

- **Docker build time:** +30-60 seconds (Node.js build stage)
- **Image size:** +minimal (CSS is not duplicated, only included once)
- **First build:** Longer (installs npm dependencies)
- **Cached builds:** Faster (only rebuilds if package.json or input.css changes)

## See Also

- `src/soulspot/static/css/input.css` - CSS source
- `src/soulspot/static/css/style.css` - CSS output (auto-generated)
- `tailwind.config.js` - Tailwind configuration
- `package.json` - Build scripts
- `docker/Dockerfile` - Docker build configuration
