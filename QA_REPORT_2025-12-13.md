# üîç QA Report - 2025-12-13

**Generated by:** QA Agent  
**Date:** 2025-12-13  
**Scope:** Full repository quality assessment (Ruff, Mypy, Bandit, Pytest)

---

## üìä Executive Summary

| Check | Status | Errors | Severity |
|-------|--------|--------|----------|
| **Ruff (Linter)** | üü° NEEDS ATTENTION | 136 | Medium |
| **Mypy (Type Checker)** | üî¥ CRITICAL | 245 | High |
| **Bandit (Security)** | üü¢ ACCEPTABLE | 11 (LOW/MEDIUM) | Low |
| **Pytest (Tests)** | üî¥ CRITICAL | 3 collection errors | High |

**Overall Status:** üî¥ BLOCKING ISSUES FOUND

---

## 1. üé® Ruff Linter Results

**Command:** `ruff check src/ tests/ --output-format=full`  
**Exit Code:** 1  
**Total Errors:** 136  
**Fixable:** 3 (with `--fix` option)

### Summary by Category:

| Rule | Count | Description |
|------|-------|-------------|
| ARG002 | ~120 | Unused method arguments (stub implementations) |
| B007 | Few | Unused loop variable |
| Others | ~10 | Various style issues |

### Key Findings:

#### 1.1 Stub Implementations (tidal_plugin.py)
**Severity:** üü° WARNING  
**Count:** ~120 errors

The `tidal_plugin.py` file contains stub implementations with unused arguments. This is expected for placeholder implementations but should be marked appropriately.

**Example:**
```python
# src/soulspot/infrastructure/plugins/tidal_plugin.py:110
async def search(
    self,
    query: str,
    types: list[str] | None = None,  # ARG002: Unused
    limit: int = 20,                  # ARG002: Unused
    offset: int = 0,                  # ARG002: Unused
) -> SearchResultDTO:
    """Search Tidal."""
    raise PluginError(
        "Tidal integration is not yet implemented. Coming soon!"
    )
```

**Recommendation:**
- Add `# noqa: ARG002` comments to stub methods
- OR: Add `_ = unused_var` assignments in stub methods
- OR: Prefix unused args with underscore: `_limit`, `_offset`

**Priority:** Low (These are intentional stubs)

#### 1.2 Additional Unused Arguments
**Severity:** üü° WARNING  
**Count:** ~10 errors

Some unused arguments in actual implementations:

1. `src/soulspot/infrastructure/providers/slskd_provider.py:149`
   - `since_hours` parameter unused in `get_completed_downloads`

**Recommendation:** Use or remove these parameters, or prefix with underscore if intentionally unused.

---

## 2. üîç Mypy Type Checking Results

**Command:** `mypy src/soulspot`  
**Exit Code:** 1 (success but with errors)  
**Total Errors:** 245 in 31 files

### Summary by Category:

| Category | Count | Severity |
|----------|-------|----------|
| attr-defined | ~80 | High |
| call-arg | ~60 | High |
| assignment | ~20 | Medium |
| no-untyped-def | ~15 | Medium |
| import-not-found | ~10 | High |
| return-value | ~10 | Medium |
| Others | ~60 | Various |

### Critical Issues:

#### 2.1 Missing/Wrong Method Names (attr-defined)
**Severity:** üî¥ CRITICAL  
**Count:** ~15 in credentials_service.py

The `AppSettingsService` class uses `get_str()` method, but mypy suggests it should be `get_string()`.

**Files Affected:**
- `src/soulspot/application/services/credentials_service.py` (multiple lines)
- `src/soulspot/infrastructure/notifications/webhook_provider.py`

**Example:**
```python
# credentials_service.py:128
client_id = await self._settings.get_str("spotify.client_id")
# Error: "AppSettingsService" has no attribute "get_str"; maybe "get_string"?
```

**Recommendation:** 
1. Check if method is `get_str()` or `get_string()`
2. Update all call sites to use the correct method name
3. OR: Add method alias if both names should be supported

**Priority:** HIGH - Breaks at runtime

#### 2.2 Wrong DTO Constructor Arguments
**Severity:** üî¥ CRITICAL  
**Count:** ~50 in deezer_plugin.py

The `deezer_plugin.py` file passes incorrect keyword arguments to various DTO constructors.

**Examples:**
```python
# Line 335: UserProfileDTO
UserProfileDTO(
    id=...,              # ‚ùå Unexpected keyword argument "id"
    service=...,         # ‚ùå Unexpected keyword argument "service"
    profile_url=...,     # ‚ùå Unexpected keyword argument "profile_url"
    followers_count=..., # ‚ùå Unexpected keyword argument "followers_count"
)

# Line 554: ArtistDTO
ArtistDTO(
    id=...,              # ‚ùå Unexpected keyword argument "id"
    external_url=...,    # ‚ùå Maybe "external_urls"?
    service=...,         # ‚ùå Unexpected keyword argument "service"
    followers_count=..., # ‚ùå Unexpected keyword argument "followers_count"
)

# Line 485: PaginatedResponse
PaginatedResponse(
    has_more=...,        # ‚ùå Unexpected keyword argument "has_more"
)
```

**Recommendation:**
1. Review DTO definitions in `src/soulspot/domain/entities/`
2. Update all DTO instantiations to match constructor signatures
3. Ensure field names match between API responses and DTOs

**Priority:** HIGH - Breaks at runtime

#### 2.3 Missing Import (import-not-found)
**Severity:** üî¥ CRITICAL  
**Count:** 1

```python
# src/soulspot/api/routers/download_manager.py:18
from sse_starlette.sse import EventSourceResponse
# Error: Cannot find implementation or library stub
```

**Status:** ‚úÖ FIXED - `sse-starlette` installed during QA run

#### 2.4 Wrong Function References
**Severity:** üî¥ CRITICAL  
**Count:** ~10

**Examples:**
```python
# src/soulspot/api/routers/notifications.py:25
from soulspot.infrastructure.persistence.database import get_session
# Error: Module has no attribute "get_session"

# src/soulspot/infrastructure/plugins/spotify_plugin.py:111
return CapabilityInfo(...)
# Error: Name "CapabilityInfo" is not defined

# src/soulspot/api/routers/downloads.py:965
def cancel_download(...):  # Already defined on line 510
# Error: Name "cancel_download" already defined
```

**Recommendation:**
1. Fix import in `notifications.py` to use `get_db_session` from dependencies
2. Import `CapabilityInfo` in spotify_plugin.py
3. Remove duplicate function definitions

**Priority:** HIGH - Breaks at runtime

#### 2.5 Type Mismatches
**Severity:** üü° WARNING  
**Count:** ~20

**Examples:**
```python
# src/soulspot/infrastructure/integrations/deezer_client.py:1117
variable_of_type_int = expression_returning_float

# src/soulspot/api/routers/library.py:2155
# Return type is HTMLResponse but signature says dict[str, Any]
```

**Recommendation:** Fix type annotations to match actual return types

---

## 3. üîí Bandit Security Results

**Command:** `bandit -r src/soulspot -f json`  
**Exit Code:** 1 (findings detected)  
**Total Findings:** 11  
**Severity Breakdown:**
- High: 0
- Medium: 3
- Low: 8

### Summary:

| Test ID | Count | Severity | Issue |
|---------|-------|----------|-------|
| B608 | 3 | MEDIUM | Possible SQL injection |
| B105 | 4 | LOW | Possible hardcoded password |
| B311 | 1 | LOW | Weak random generator |
| B110 | 1 | LOW | Try-except-pass |
| B101 | 2 | LOW | Assert used |

### Medium Severity Issues:

#### 3.1 Possible SQL Injection (B608)
**Severity:** üü° MEDIUM  
**Count:** 3  
**File:** `src/soulspot/infrastructure/notifications/inapp_provider.py`

**Locations:**
1. Line 286-292: Dynamic WHERE clause construction
2. Line 335-339: UPDATE with dynamic placeholders
3. Line 342-346: UPDATE with dynamic placeholders

**Code Examples:**
```python
# Line 286
query = text(f"""
    SELECT id, type, title, message, priority, data, created_at, read, user_id
    FROM notifications
    WHERE {where_clause}  # ‚ö†Ô∏è Dynamic SQL
    ORDER BY created_at DESC
    LIMIT :limit OFFSET :offset
""")

# Line 335
query = text(f"""
    UPDATE notifications
    SET read = TRUE
    WHERE id IN ({placeholders})  # ‚ö†Ô∏è Dynamic placeholders
    AND user_id = :user_id
""")
```

**Analysis:**
- The `where_clause` and `placeholders` are constructed from safe sources (internal logic)
- Parameters are properly bound using SQLAlchemy's parameterization
- Risk is LOW in practice, but pattern should be improved

**Recommendation:**
1. Use SQLAlchemy's query builder instead of raw SQL with f-strings
2. OR: Add detailed comments explaining why this is safe
3. OR: Use `# nosec B608` with justification comment

**Priority:** MEDIUM (False positive but bad pattern)

### Low Severity Issues:

#### 3.2 Hardcoded Password Checks (B105)
**Severity:** üü¢ LOW  
**Count:** 4

These are false positives - the code checks if a value equals `"***"` (a masking placeholder), not an actual hardcoded password.

**Files:**
- `src/soulspot/api/routers/settings.py` (lines 248, 264, 270)
- `src/soulspot/domain/value_objects/naming.py` (line 417)

**Recommendation:** Add `# nosec B105` comments

#### 3.3 Weak Random Generator (B311)
**Severity:** üü¢ LOW  
**Count:** 1  
**File:** `src/soulspot/api/routers/ui.py:2334`

```python
sample_artists = random.sample(artists, sample_size)
```

**Analysis:** Used for UI sampling, not security. Safe to ignore.

**Recommendation:** No action needed (or add `# nosec B311`)

#### 3.4 Try-Except-Pass (B110)
**Severity:** üü¢ LOW  
**Count:** 1  
**File:** `src/soulspot/application/use_cases/queue_album_downloads.py:483`

**Recommendation:** Add logging in except block or explicit comment

#### 3.5 Assert Used (B101)
**Severity:** üü¢ LOW  
**Count:** 2  
**File:** `src/soulspot/infrastructure/integrations/deezer_client.py` (lines 224, 258)

```python
assert self._oauth_config is not None  # For type checker
```

**Analysis:** These are type-checking assertions. Should be replaced with proper type narrowing or runtime checks.

**Recommendation:** 
```python
if self._oauth_config is None:
    raise RuntimeError("OAuth not configured")
```

---

## 4. üß™ Pytest Test Results

**Command:** `pytest tests/ -v -m "not slow"`  
**Exit Code:** 1 (errors during collection)  
**Tests Collected:** 960 (911 unit + 49 integration)  
**Tests Selected:** 960  
**Tests Deselected:** 132 (slow tests)

### Collection Errors:

#### 4.1 Import Error: get_session
**Severity:** üî¥ CRITICAL  
**Count:** 3 test files blocked

**Files Affected:**
- `tests/integration/api/test_downloads.py`
- `tests/unit/api/test_playlist_import.py`
- `tests/unit/api/test_search_router.py`

**Error:**
```
ImportError: cannot import name 'get_session' from 
'soulspot.infrastructure.persistence.database'
```

**Root Cause:**
`src/soulspot/api/routers/notifications.py:25` imports non-existent `get_session` function.

**Recommendation:**
```python
# WRONG:
from soulspot.infrastructure.persistence.database import get_session

# CORRECT:
from soulspot.api.dependencies import get_db_session
```

**Impact:** Blocks 3+ test files from running

**Priority:** CRITICAL - Must fix to run tests

---

## 5. üìã Recommendations by Priority

### üî¥ CRITICAL (Must Fix Immediately)

1. **Fix notifications.py import** (blocks tests)
   - Change `get_session` to `get_db_session` from dependencies
   - Impact: Unblocks 3+ test files

2. **Fix DTO constructor mismatches** (~50 errors in deezer_plugin.py)
   - Review all DTO definitions
   - Update instantiations to match signatures
   - Impact: Runtime crashes prevented

3. **Fix wrong method names** (~15 errors in credentials_service.py)
   - Verify: `get_str()` vs `get_string()`
   - Update all call sites consistently
   - Impact: Runtime AttributeErrors prevented

4. **Remove duplicate function definitions** (downloads.py)
   - Lines 510, 579, 633 vs 965, 1007, 1054
   - Impact: Code maintainability

### üü° MEDIUM (Should Fix Soon)

5. **Refactor SQL string construction** (inapp_provider.py)
   - Use SQLAlchemy query builder
   - OR: Add safety comments + `# nosec B608`
   - Impact: Security best practices

6. **Fix type mismatches** (~20 errors)
   - Update return type annotations
   - Fix assignment type conflicts
   - Impact: Type safety

7. **Mark stub implementations** (tidal_plugin.py)
   - Add `# noqa: ARG002` to stub methods
   - OR: Prefix args with underscore
   - Impact: Linter noise reduction

### üü¢ LOW (Nice to Have)

8. **Replace asserts with proper checks** (deezer_client.py)
   - Convert type-checking asserts to runtime checks
   - Impact: Production safety

9. **Add logging to try-except-pass** (queue_album_downloads.py)
   - Log suppressed exceptions
   - Impact: Debugging visibility

10. **Clean up false positive security warnings**
    - Add `# nosec` comments with justifications
    - Impact: Signal-to-noise ratio

---

## 6. üéØ Quality Metrics

### Code Quality Score: 68/100

**Breakdown:**
- **Functionality:** 70/100 (tests blocked by import errors)
- **Type Safety:** 55/100 (245 mypy errors)
- **Security:** 85/100 (no high/critical findings)
- **Style:** 75/100 (136 linter warnings)
- **Test Coverage:** N/A (couldn't run coverage due to import errors)

### Estimated Fix Time:
- Critical issues: 2-4 hours
- Medium issues: 4-6 hours
- Low issues: 2-3 hours
- **Total:** 8-13 hours

---

## 7. üìù Next Steps

### Immediate Actions:
1. ‚úÖ Install missing dependency: `sse-starlette` (DONE)
2. ‚ùå Fix `notifications.py` import issue
3. ‚ùå Fix DTO constructor signatures
4. ‚ùå Re-run pytest to verify tests pass

### Short Term:
5. Fix method name mismatches (`get_str` vs `get_string`)
6. Review and update type annotations
7. Clean up duplicate function definitions

### Long Term:
8. Refactor SQL string construction
9. Add comprehensive type coverage
10. Increase test coverage to 80%+ target

---

## 8. üîß Commands to Fix Issues

### Fix Critical Import Issue:
```bash
# Edit src/soulspot/api/routers/notifications.py
# Line 25, change:
from soulspot.infrastructure.persistence.database import get_session
# To:
from soulspot.api.dependencies import get_db_session

# Then update all uses of get_session in the file to get_db_session
```

### Run Auto-Fixable Linter Issues:
```bash
ruff check src/ tests/ --fix
```

### Re-run Tests After Fixes:
```bash
pytest tests/ -v -m "not slow"
```

### Generate Coverage Report:
```bash
pytest tests/ -m "not slow" --cov=src/soulspot --cov-report=html --cov-report=term
```

---

## 9. üìä Files with Most Issues

| File | Ruff | Mypy | Bandit | Total |
|------|------|------|--------|-------|
| `infrastructure/plugins/tidal_plugin.py` | 120 | 0 | 0 | 120 |
| `infrastructure/plugins/deezer_plugin.py` | 5 | 50 | 0 | 55 |
| `application/services/credentials_service.py` | 0 | 15 | 0 | 15 |
| `infrastructure/notifications/inapp_provider.py` | 0 | 0 | 3 | 3 |
| `api/routers/notifications.py` | 0 | 1 | 0 | 1 |

---

## 10. ‚úÖ CI/CD Quality Gates Status

Minimum requirements for merging:
- ‚úÖ Ruff: <50 errors ‚Üí ‚ùå FAIL (136 errors)
- ‚úÖ Mypy: No errors in changed files ‚Üí ‚ùå FAIL (245 errors)
- ‚úÖ Bandit: No high/critical issues ‚Üí ‚úÖ PASS (only LOW/MEDIUM)
- ‚úÖ Pytest: All tests passing ‚Üí ‚ùå FAIL (3 collection errors)
- ‚úÖ Coverage: No decrease from baseline ‚Üí ‚ö†Ô∏è UNKNOWN (can't measure)

**Overall Gate Status:** üî¥ BLOCKING - Cannot merge

---

## üìû Contact & Follow-up

**Generated by:** QA Agent  
**Report Date:** 2025-12-13  
**Next Review:** After critical fixes applied

**Questions?** Review QA_COMMANDS.md for detailed command reference.

---

**End of Report**
